import{f as J,d as D,W as E,t as j,am as T,i as k,r as V,ap as C,o as u,c as f,O as o,a7 as x,a as q,D as z,F as L,H as N,N as w,J as m,_ as B}from"./index-5d85e9da.js";import{u as R}from"./user-838cdd03.js";import{e as G}from"./_queries-0bd36c18.js";import{p as S}from"./index-4972ba4e.js";const{withClientQuery:H}=J(),K=D("auditlog",{state:()=>({auditLogs:[],fetchingAudits:!1,error:null}),getters:{getAuditLogs:c=>c.auditLogs,isLoading:c=>c.fetchingAudits,hasError:c=>c.error!==null},actions:{async fetchAuditLogs(c){this.fetchingAudits=!0,this.error=null;try{const l=await H(G,c,"auditLogsFilter");l&&Array.isArray(l)?this.auditLogs=l.map(h=>{const a={...h};if(typeof a.stateAfter=="string")try{a.stateAfter=JSON.parse(a.stateAfter)}catch(p){console.error("Failed to parse stateAfter JSON:",p)}if(typeof a.stateBefore=="string")try{a.stateBefore=JSON.parse(a.stateBefore)}catch(p){console.error("Failed to parse stateBefore JSON:",p)}if(typeof a.extras=="string")try{a.extras=JSON.parse(a.extras)}catch(p){console.error("Failed to parse extras JSON:",p)}return a}):this.auditLogs=[]}catch(l){this.error=l instanceof Error?l.message:"Unknown error occurred",console.error("Error fetching audit logs:",l)}finally{this.fetchingAudits=!1}},resetLogs(){this.auditLogs=[],this.error=null}}}),Q={class:"relative mt-4",role:"log","aria-label":"Audit log"},W={key:0,class:"py-4 text-center"},I={key:1,initial:{opacity:0,y:100},enter:{opacity:1,y:0,scale:1},variants:{custom:{scale:2}},delay:200,class:"list-none m-0 p-0 space-y-4"},M={class:"flex items-center mb-2"},P={class:"ml-4 font-medium"},X={class:"text-foreground"},Y={class:"text-primary"},Z={class:"text-muted-foreground"},$={class:"ml-12 space-y-2"},ee={class:"col-span-1"},te={class:"text-sm text-muted-foreground"},se={key:0,class:"col-span-3"},re={class:"text-xs text-muted-secondary"},oe={key:1,class:"col-span-3 flex items-center gap-2"},ae={class:"text-xs text-destructive line-through"},ie={class:"text-xs text-primary"},ne=E({__name:"FelAuditLog",props:{targetUid:{type:String,required:!1,default:void 0},targetType:{type:String,required:!1,default:void 0}},setup(c){const l=c,{targetType:h,targetUid:a}=j(l),p=R(),b=K();b.resetLogs();const{auditLogs:O,fetchingAudits:A}=T(b);p.fetchUsers({}),b.fetchAuditLogs({targetType:h?.value,targetUid:a?.value});const U=k(()=>p.getUsers);function i(g){const r=U.value?.find(_=>(_.uid||_.userUid)?.toString()===g?.toString());return r?.userName||r?.firstName||r?.lastName||""}function v(g){switch(g){case 1:return"created";case 2:return"updated";case 3:return"deleted";default:return""}}function F(g){const r=new Set;return Object.entries(g?.stateBefore||{}).forEach(([_,e])=>{Object.entries(g?.stateAfter||{}).forEach(([t,s])=>{if(_===t&&e!==s){let y=t,n=e,d=s;t==="updated_by_uid"?(y="updated_by",n=i(e),d=i(s)):t==="submitted_by_uid"?(y="submitted_by",n=i(e),d=i(s)):t==="verified_by_uid"?(y="verified_by",n=i(e),d=i(s)):t==="updated_at"?(y="updated_on",n=S(e),d=S(s)):t==="cancelled_by_uid"?(y="cancelled_by",n=i(e),d=i(s)):t==="received_by_uid"&&(y="received_by",n=i(e),d=i(s)),r.add({key:y,old:n!=null&&typeof n=="object"?JSON.stringify(n):String(n||"None"),new:d!=null&&typeof d=="object"?JSON.stringify(d):String(d||"None")})}})}),Object.entries(g?.extras||{}).forEach(([_,e])=>{e!=null&&e!==""&&r.add({key:_,raw:typeof e=="object"?JSON.stringify(e):String(e)})}),Array.from(r)}return(g,r)=>{const _=V("fel-loader"),e=C("motion");return u(),f("div",Q,[r[2]||(r[2]=o("div",{class:"border-r-2 border-border border-dotted absolute h-full top-0 z-0",style:{left:"7px"},"aria-hidden":"true"},null,-1)),x(A)?(u(),f("div",W,[q(_,{message:"Fetching audit logs ..."})])):z((u(),f("ul",I,[(u(!0),f(L,null,N(x(O),t=>(u(),f("li",{key:t.uid,class:"relative"},[o("div",M,[r[0]||(r[0]=o("div",{class:"bg-accent rounded-full h-4 w-4 border-border border-2 z-10","aria-hidden":"true"},null,-1)),o("div",P,[o("span",X,[w(m(i(t?.userUid))+" ",1),o("span",Y,m(v(t?.action)),1),w(" "+m(t?.targetType),1)]),o("span",Z," on "+m(x(S)(t?.stateAfter?.updated_at)),1)])]),o("div",$,[(u(!0),f(L,null,N(F(t),s=>(u(),f("div",{key:s.key,class:"grid grid-cols-4 gap-2 items-center"},[o("span",ee,[o("span",te,m(s?.key),1)]),s?.raw?(u(),f("span",se,[o("span",re,m(s?.raw),1)])):(u(),f("span",oe,[o("span",ae,m(s?.old),1),r[1]||(r[1]=o("span",{class:"text-xs text-muted-foreground","aria-hidden":"true"},"â†’",-1)),o("span",ie,m(s?.new),1)]))]))),128))])]))),128))])),[[e]])])}}}),fe=B(ne,[["__file","/home/aurthurm/Documents/Development/felicity/felicity-lims/webapp/components/audit/FelAuditLog.vue"]]);export{fe as default};
