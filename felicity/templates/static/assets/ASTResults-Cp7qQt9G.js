import{a0 as re,u as ue,f as de,h as ce,a7 as g,ad as me,a5 as fe,aq as be,U as ge,_ as pe,r as B,c,o as d,A as o,C as ve,E as ye,J as p,K as y,F as v,L as h,H as S,a9 as G,a2 as H,Q as J,a as V,a3 as he,N as P,P as j,D as N}from"./index-Cdc6vSVw.js";import{u as xe}from"./analysis-Bps2zdEt.js";import{s as _e}from"./index-Df7aGkrY.js";import{G as Re,b as Ae,c as Ue,d as Ce,e as we,f as Se,U as Pe}from"./microbiology.mutations-CQJcOUVA.js";import"./analyses.mutations-DiZ_xJnn.js";const Te=re({__name:"ASTResults",props:{sample:{type:Object,required:!0},organismAnalysisResults:{type:Object,required:!0}},setup(b,{expose:u}){u();const A=ue(),{withClientMutation:e,withClientQuery:_}=de(),M=ce(()=>b.organismAnalysisResults[0]),R=g([]),x=g([]),T=g([]),t=g([]);me(()=>{_(Re,{analysisResultUid:M.value.uid},"abxOrganismResultAll").then(s=>{s&&(x.value=s||[])}).finally(()=>w()),C(),_(Ae,{},"abxGuidelineYearAll").then(s=>{s&&(T.value=s||[])}),_(Ue,{},"abxTestMethodAll").then(s=>{s&&(t.value=s||[])})});const n=g(!1),r=g(!1),k=g(""),F=g([]),U=g();function C(){_(Ce,{sampleUid:b.sample.uid},"abxAstResultAll").then(s=>{s&&(R.value=s||[])}).finally(()=>w())}function K(s){U.value=s,n.value=!0}function W(s){const a=f.value[s.uid];return a?Object.values(a)?.every(m=>m.status=="pending"):!1}function X(){r.value=!0,_(we,{organismUid:U.value?.uid,text:k.value},"abxAstPanelFilter").then(s=>{s&&(F.value=s||[])}).finally(()=>{r.value=!1})}function Z(s){n.value=!1,be.fire({title:"Are you sure?",text:"You want to apply panel: "+s.name+" to organism: "+U.value?.organism?.name,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, apply now!",cancelButtonText:"No, do not apply!"}).then(async a=>{a.isConfirmed&&e(Se,{payload:{organismResultUid:U.value?.uid,panelUid:s.uid,sampleUid:b.sample.uid}},"applyAbxAstPanel").then(m=>{m?.astResults?.forEach(l=>R.value.push(l)),w()})})}const f=g({});function w(){const s={};x.value?.forEach(a=>{s[a.uid]={},(R.value?.filter(l=>l.organismResultUid===a.uid)).forEach(l=>{l.antibiotic?.name&&(s[a.uid][l.antibiotic.name+" "+l.antibiotic.potency]={uid:l.uid,analResultUid:l.analysisResultUid,status:l.analysisResult?.status,astMethodUid:l.astMethodUid??"",guidelineYearUid:l.guidelineYearUid??"",breakpointUid:l.breakpointUid??"",astValue:l.astValue??"",result:l.analysisResult?.result??"",reportable:l.analysisResult?.reportable??!1,dirty:!1})})}),f.value=s}fe([x,R],()=>{w()});const O=s=>Object.keys(f.value[s]||{});let{submitResults:E,approveResults:D}=xe();function $(s){const a=f.value[s];if(!a)return!1;const m=Object.values(a)?.some(i=>i.dirty&&i.status=="pending"),l=Object.values(a)?.some(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue);return m&&l}function I(s){const a=f.value[s];return(Object.values(a)?.filter(i=>i.dirty&&i.status=="pending")).filter(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue).map(({dirty:i,breakpointUid:ae,analResultUid:z,status:bt,...ie})=>ie)}const Y=g(!1);function ee(s){Y.value=!0;const a=I(s);e(Pe,{payload:{results:a}},"updateAbxAstResults").then(()=>{A.fetchAnalysisResultsForSample(b.sample.uid),C()}).finally(()=>Y.value=!1)}function te(s){const a=f.value[s];if(!a)return!1;const m=Object.values(a)?.some(i=>i.dirty),l=Object.values(a)?.some(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue&&i.result&&i.status=="pending");return!m&&l&&b.sample.status!="submitting"}function L(s){const a=f.value[s];return(Object.values(a)?.filter(i=>!i.dirty)).filter(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue&&i.result&&i.status=="pending").map(({dirty:i,breakpointUid:ae,...z})=>z)}function se(s){const m=L(s).map(l=>({uid:l.analResultUid,result:l.result??"",reportable:l.reportable??!1,methodUid:"felicity_ast",laboratoryInstrumentUid:"felicity_ast"}));E(m,ge.Sample,b.sample?.uid).then(()=>{A.fetchAnalysisResultsForSample(b.sample.uid),C()})}function oe(s){const a=f.value[s];if(!a)return!1;const m=Object.values(a)?.some(i=>i.dirty),l=Object.values(a)?.some(i=>i.status=="resulted");return!m&&l&&b.sample.status!="approving"}function q(s){const a=f.value[s];return(Object.values(a)?.filter(l=>!l.dirty)).filter(l=>l.status=="resulted")}function ne(s){const m=q(s).map(l=>l.analResultUid);D(m,"sample",b.sample?.uid).then(()=>{A.fetchAnalysisResultsForSample(b.sample.uid),C()})}async function le(s,a,m,l){f.value[s][a],f.value[s][a].dirty=!0,f.value[s][a]={...f.value[s][a],[m]:l}}const Q={sampleStore:A,withClientMutation:e,withClientQuery:_,organismResult:M,astResults:R,pickedOrganisms:x,guidelines:T,testMethods:t,showModal:n,loadingPanels:r,searchPanelText:k,panels:F,choiceOrganism:U,fetchAstResultAll:C,choosePanel:K,canAddPanel:W,searchPanels:X,applyPanel:Z,organismResults:f,processASTResults:w,getAntibiotics:O,get submitter_(){return E},set submitter_(s){E=s},get approver_(){return D},set approver_(s){D=s},canSave:$,getSavable:I,savingAntibiotics:Y,saveAntibiotics:ee,canSubmit:te,getSubmittable:L,submitAntibiotics:se,canApprove:oe,getApprovable:q,approveAntibiotics:ne,handleCellEdit:le,get shield(){return _e}};return Object.defineProperty(Q,"__isScriptSetup",{enumerable:!1,value:!0}),Q}}),Ve={class:"space-y-6"},je={class:"space-y-8"},Me={class:"flex items-center justify-between"},Ee={class:"space-x-2"},De={class:"font-semibold text-foreground"},Ye={class:"text-muted-foreground"},Be=["onClick"],Ge={class:"rounded-lg border border-border bg-background"},Ne={class:"overflow-x-auto"},ke={class:"w-full"},Fe={class:"border-b border-border bg-muted/50"},Ie={class:"border-b border-border"},Le=["onUpdate:modelValue","onChange","disabled"],qe=["value"],Qe={class:"border-b border-border"},ze=["onUpdate:modelValue","onChange","disabled"],He=["value"],Je={class:"border-b border-border"},Ke=["onUpdate:modelValue","onChange","disabled"],We={class:"border-b border-border"},Xe={class:"flex items-center space-x-2"},Ze=["onUpdate:modelValue","onChange","disabled"],Oe={class:"flex items-center space-x-4"},$e=["onUpdate:modelValue","onChange","disabled"],et={class:"flex items-center space-x-4"},tt={class:"text-lg font-semibold text-foreground"},st={class:"italic"},ot={class:"space-y-6"},nt={class:"space-y-4"},lt={class:"rounded-lg border border-border"},at={class:"overflow-y-auto max-h-64"},it={class:"w-full"},rt={class:"px-4 py-3"},ut={class:"font-medium text-foreground"},dt={class:"text-sm text-muted-foreground"},ct={class:"px-4 py-3 text-right"},mt=["onClick"];function ft(b,u,A,e,_,M){const R=B("font-awesome-icon"),x=B("fel-button"),T=B("fel-modal");return d(),c(p,null,[o("div",Ve,[u[12]||(u[12]=o("div",{class:"flex items-center justify-between border-b border-border pb-4"},[o("h3",{class:"text-lg font-semibold text-foreground"},"AST Panel")],-1)),o("div",je,[(d(!0),c(p,null,y(e.pickedOrganisms,t=>(d(),c("div",{key:t.uid,class:"space-y-6"},[o("div",Me,[o("div",Ee,[o("span",De,"Organism #"+h(t?.isolateNumber),1),o("span",Ye,h(t?.organism?.name),1)]),v(o("button",{onClick:n=>e.choosePanel(t),class:"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"}," Choose Panel ",8,Be),[[S,e.canAddPanel(t)]])]),o("div",Ge,[o("div",Ne,[o("table",ke,[o("thead",null,[o("tr",Fe,[u[2]||(u[2]=o("th",{class:"px-4 py-3 text-left text-sm font-medium text-muted-foreground"},"Parameter",-1)),(d(!0),c(p,null,y(e.getAntibiotics(t.uid),n=>(d(),c("th",{key:n,class:"px-4 py-3 text-left text-sm font-medium text-muted-foreground"},h(n),1))),128))])]),o("tbody",null,[o("tr",Ie,[u[3]||(u[3]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"Guideline",-1)),(d(!0),c(p,null,y(e.getAntibiotics(t.uid),n=>(d(),c("td",{key:n,class:"px-4 py-3"},[v(o("select",{"onUpdate:modelValue":r=>e.organismResults[t.uid][n].guidelineYearUid=r,onChange:r=>e.handleCellEdit(t.uid,n,"guidelineYearUid",r.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[t.uid][n].status!=="pending"},[(d(!0),c(p,null,y(e.guidelines,r=>(d(),c("option",{key:r.uid,value:r.uid},h(r.code),9,qe))),128))],40,Le),[[G,e.organismResults[t.uid][n].guidelineYearUid]])]))),128))]),o("tr",Qe,[u[4]||(u[4]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"AST Method",-1)),(d(!0),c(p,null,y(e.getAntibiotics(t.uid),n=>(d(),c("td",{key:n,class:"px-4 py-3"},[v(o("select",{"onUpdate:modelValue":r=>e.organismResults[t.uid][n].astMethodUid=r,onChange:r=>e.handleCellEdit(t.uid,n,"astMethodUid",r.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[t.uid][n].status!=="pending"},[(d(!0),c(p,null,y(e.testMethods,r=>(d(),c("option",{key:r.uid,value:r.uid},h(r.name),9,He))),128))],40,ze),[[G,e.organismResults[t.uid][n].astMethodUid]])]))),128))]),o("tr",Je,[u[5]||(u[5]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"AST Value",-1)),(d(!0),c(p,null,y(e.getAntibiotics(t.uid),n=>(d(),c("td",{key:n,class:"px-4 py-3"},[v(o("input",{type:"number","onUpdate:modelValue":r=>e.organismResults[t.uid][n].astValue=r,onChange:r=>e.handleCellEdit(t.uid,n,"astValue",r.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",step:"0.1",disabled:e.organismResults[t.uid][n].status!=="pending"},null,40,Ke),[[H,e.organismResults[t.uid][n].astValue]])]))),128))]),o("tr",We,[u[7]||(u[7]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"Result",-1)),(d(!0),c(p,null,y(e.getAntibiotics(t.uid),n=>(d(),c("td",{key:n,class:"px-4 py-3"},[o("div",Xe,[v(o("select",{"onUpdate:modelValue":r=>e.organismResults[t.uid][n].result=r,onChange:r=>e.handleCellEdit(t.uid,n,"result",r.target.value),class:J(["w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",{"text-success":e.organismResults[t.uid][n].result?.toUpperCase()==="S","text-warning":e.organismResults[t.uid][n].result?.toUpperCase()==="I","text-destructive":e.organismResults[t.uid][n].result?.toUpperCase()==="R"}]),disabled:e.organismResults[t.uid][n].status!=="pending"},[...u[6]||(u[6]=[o("option",{value:"S"},"S",-1),o("option",{value:"I"},"I",-1),o("option",{value:"R"},"R",-1)])],42,Ze),[[G,e.organismResults[t.uid][n].result]]),v(o("span",null,[V(R,{icon:"robot",class:"text-muted-foreground","aria-label":"Auto-calculated"})],512),[[S,e.organismResults[t.uid][n].breakpointUid]])])]))),128))]),o("tr",null,[u[8]||(u[8]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"Reportable",-1)),(d(!0),c(p,null,y(e.getAntibiotics(t.uid),n=>(d(),c("td",{key:n,class:"px-4 py-3"},[o("div",Oe,[v(o("input",{type:"checkbox","onUpdate:modelValue":r=>e.organismResults[t.uid][n].reportable=r,onChange:r=>e.handleCellEdit(t.uid,n,"reportable",r.target.checked),class:"rounded border-input text-primary focus:ring-primary disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[t.uid][n].status!=="pending"},null,40,$e),[[he,e.organismResults[t.uid][n].reportable]]),o("span",{class:J(["inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",{"bg-primary/10 text-primary":e.organismResults[t.uid][n].status==="pending","bg-warning/10 text-warning":e.organismResults[t.uid][n].status==="resulted","bg-success/10 text-success":e.organismResults[t.uid][n].status==="approved","bg-destructive/10 text-destructive":e.organismResults[t.uid][n].status==="cancelled"}])},h(e.organismResults[t.uid][n].status),3)])]))),128))])])])])]),o("div",et,[v(V(x,{key:"save",onClick:N(n=>e.saveAntibiotics(t.uid),["prevent"]),color:"primary",disabled:e.savingAntibiotics},{default:P(()=>[...u[9]||(u[9]=[j(" Save Antibiotics ",-1)])]),_:1},8,["onClick","disabled"]),[[S,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canSave(t.uid)]]),v(V(x,{key:"submit",onClick:N(n=>e.submitAntibiotics(t.uid),["prevent"]),color:"warning"},{default:P(()=>[...u[10]||(u[10]=[j(" Submit Antibiotics ",-1)])]),_:1},8,["onClick"]),[[S,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canSubmit(t.uid)]]),v(V(x,{key:"approve",onClick:N(n=>e.approveAntibiotics(t.uid),["prevent"]),color:"success"},{default:P(()=>[...u[11]||(u[11]=[j(" Approve Antibiotics ",-1)])]),_:1},8,["onClick"]),[[S,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canApprove(t.uid)]])])]))),128))])]),e.showModal?(d(),ve(T,{key:0,onClose:u[1]||(u[1]=t=>e.showModal=!1),contentWidth:"w-1/2"},{header:P(()=>[o("h3",tt,[u[13]||(u[13]=j(" Search Panel for ",-1)),o("span",st,h(e.choiceOrganism?.organism?.name),1)])]),body:P(()=>[o("div",ot,[o("div",nt,[v(o("input",{"onUpdate:modelValue":u[0]||(u[0]=t=>e.searchPanelText=t),onInput:e.searchPanels,class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",placeholder:"Begin typing..."},null,544),[[H,e.searchPanelText]]),o("div",lt,[o("div",at,[o("table",it,[o("tbody",null,[(d(!0),c(p,null,y(e.panels,t=>(d(),c("tr",{key:t.uid,class:"border-b border-border hover:bg-muted/50 transition-colors duration-200"},[o("td",rt,[o("div",ut,h(t.name),1),o("div",dt,h(t.antibiotics?.map(n=>n.name)?.join(", ")),1)]),o("td",ct,[o("button",{onClick:n=>e.applyPanel(t),class:"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2"}," Apply ",8,mt)])]))),128))])])])])])])]),_:1})):ye("",!0)],64)}const xt=pe(Te,[["render",ft],["__file","/home/aurthurm/Documents/Development/felicity/felicity-lims/webapp/views/sample/_id/results/ASTResults.vue"]]);export{xt as default};
