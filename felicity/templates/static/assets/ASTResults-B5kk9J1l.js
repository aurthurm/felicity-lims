import{Y as re,P as de,u as ce,a7 as fe,a0 as x,ah as me,an as be,aN as ge,R as ve,a3 as pe,_ as ye,r as U,c as v,o as f,z as i,A as w,C as xe,F as h,H as R,D as A,I as C,E as Y,a as c,K as u,M as _,aG as H,al as W,N as J}from"./index-OdhKCqIc.js";import{u as he}from"./analysis-axSHEiPd.js";import{s as _e}from"./index-DJJ2wcNX.js";import{G as Re,b as Ae,c as Ue,d as Ce,e as we,f as Te,U as Se}from"./microbiology.mutations-cVAbKt4K.js";import"./analyses.mutations-DUxQZn1r.js";const Pe=re({__name:"ASTResults",props:{sample:{type:Object,required:!0},organismAnalysisResults:{type:Object,required:!0}},setup(y,{expose:r}){r();const M=de(),{withClientMutation:e,withClientQuery:T}=ce(),{confirm:G}=ge(),j=fe(()=>y.organismAnalysisResults[0]),p=x([]),S=x([]),b=x([]),B=x([]);me(()=>{T(Re,{analysisResultUid:j.value.uid},"abxOrganismResultAll").then(l=>{l&&(S.value=l||[])}).finally(()=>D()),t(),T(Ae,{},"abxGuidelineYearAll").then(l=>{l&&(b.value=l||[])}),T(Ue,{},"abxTestMethodAll").then(l=>{l&&(B.value=l||[])})});const V=x(!1),P=x(!1),E=x(""),k=x([]),s=x();function t(){T(Ce,{sampleUid:y.sample.uid},"abxAstResultAll").then(l=>{l&&(p.value=l||[])}).finally(()=>D())}function d(l){s.value=l,V.value=!0}function X(l){const a=g.value[l.uid];return a?Object.values(a)?.every(m=>m.status=="pending"):!1}function Z(){P.value=!0,T(we,{organismUid:s.value?.uid,text:E.value},"abxAstPanelFilter").then(l=>{l&&(k.value=l||[])}).finally(()=>{P.value=!1})}async function O(l){if(V.value=!1,!await G({title:"Are you sure?",description:`You want to apply panel: ${l.name} to organism: ${s.value?.organism?.name}`,confirmText:"Yes, apply now!",cancelText:"No, do not apply!",variant:"destructive"}))return;(await e(Te,{payload:{organismResultUid:s.value?.uid,panelUid:l.uid,sampleUid:y.sample.uid}},"applyAbxAstPanel"))?.astResults?.forEach(n=>p.value.push(n)),D()}const g=x({});function D(){const l={};S.value?.forEach(a=>{l[a.uid]={},(p.value?.filter(n=>n.organismResultUid===a.uid)).forEach(n=>{n.antibiotic?.name&&(l[a.uid][n.antibiotic.name+" "+n.antibiotic.potency]={uid:n.uid,analResultUid:n.analysisResultUid,status:n.analysisResult?.status,astMethodUid:n.astMethodUid??"",guidelineYearUid:n.guidelineYearUid??"",breakpointUid:n.breakpointUid??"",astValue:n.astValue??"",result:n.analysisResult?.result??"",reportable:n.analysisResult?.reportable??!1,dirty:!1})})}),g.value=l}be([S,p],()=>{D()});const $=l=>Object.keys(g.value[l]||{});let{submitResults:N,approveResults:F}=he();function ee(l){const a=g.value[l];if(!a)return!1;const m=Object.values(a)?.some(o=>o.dirty&&o.status=="pending"),n=Object.values(a)?.some(o=>o.guidelineYearUid&&o.astMethodUid&&o.astValue);return m&&n}function L(l){const a=g.value[l];return(Object.values(a)?.filter(o=>o.dirty&&o.status=="pending")).filter(o=>o.guidelineYearUid&&o.astMethodUid&&o.astValue).map(({dirty:o,breakpointUid:ie,analResultUid:Q,status:ns,...ue})=>ue)}const I=x(!1);function se(l){I.value=!0;const a=L(l);e(Se,{payload:{results:a}},"updateAbxAstResults").then(()=>{M.fetchAnalysisResultsForSample(y.sample.uid),t()}).finally(()=>I.value=!1)}function te(l){const a=g.value[l];if(!a)return!1;const m=Object.values(a)?.some(o=>o.dirty),n=Object.values(a)?.some(o=>o.guidelineYearUid&&o.astMethodUid&&o.astValue&&o.result&&o.status=="pending");return!m&&n&&y.sample.status!="submitting"}function q(l){const a=g.value[l];return(Object.values(a)?.filter(o=>!o.dirty)).filter(o=>o.guidelineYearUid&&o.astMethodUid&&o.astValue&&o.result&&o.status=="pending").map(({dirty:o,breakpointUid:ie,...Q})=>Q)}function le(l){const m=q(l).map(n=>({uid:n.analResultUid,result:n.result??"",reportable:n.reportable??!1,methodUid:"felicity_ast",laboratoryInstrumentUid:"felicity_ast"}));N(m,ve.Sample,y.sample?.uid).then(()=>{M.fetchAnalysisResultsForSample(y.sample.uid),t()})}function ne(l){const a=g.value[l];if(!a)return!1;const m=Object.values(a)?.some(o=>o.dirty),n=Object.values(a)?.some(o=>o.status=="resulted");return!m&&n&&y.sample.status!="approving"}function z(l){const a=g.value[l];return(Object.values(a)?.filter(n=>!n.dirty)).filter(n=>n.status=="resulted")}function oe(l){const m=z(l).map(n=>n.analResultUid);F(m,"sample",y.sample?.uid).then(()=>{M.fetchAnalysisResultsForSample(y.sample.uid),t()})}async function ae(l,a,m,n){g.value[l][a],g.value[l][a].dirty=!0,g.value[l][a]={...g.value[l][a],[m]:n}}const K={sampleStore:M,withClientMutation:e,withClientQuery:T,confirm:G,organismResult:j,astResults:p,pickedOrganisms:S,guidelines:b,testMethods:B,showModal:V,loadingPanels:P,searchPanelText:E,panels:k,choiceOrganism:s,fetchAstResultAll:t,choosePanel:d,canAddPanel:X,searchPanels:Z,applyPanel:O,organismResults:g,processASTResults:D,getAntibiotics:$,get submitter_(){return N},set submitter_(l){N=l},get approver_(){return F},set approver_(l){F=l},canSave:ee,getSavable:L,savingAntibiotics:I,saveAntibiotics:se,canSubmit:te,getSubmittable:q,submitAntibiotics:le,canApprove:ne,getApprovable:z,approveAntibiotics:oe,handleCellEdit:ae,get Button(){return pe},get shield(){return _e}};return Object.defineProperty(K,"__isScriptSetup",{enumerable:!1,value:!0}),K}}),Me={class:"space-y-6"},je={class:"space-y-8"},Ve={class:"flex items-center justify-between"},Ee={class:"space-x-2"},De={class:"font-semibold text-foreground"},Ye={class:"text-muted-foreground"},Be=["onClick"],ke={class:"rounded-lg border border-border bg-background"},Ge={class:"overflow-x-auto"},Ne=["onUpdate:modelValue","onChange","disabled"],Fe=["value"],Ie=["onUpdate:modelValue","onChange","disabled"],He=["value"],Le=["onUpdate:modelValue","onChange","disabled"],qe={class:"flex items-center space-x-2"},ze=["onUpdate:modelValue","onChange","disabled"],Ke={class:"flex items-center space-x-4"},Qe={class:"flex items-center space-x-4"},We={class:"text-lg font-semibold text-foreground"},Je={class:"italic"},Xe={class:"space-y-6"},Ze={class:"space-y-4"},Oe={class:"rounded-lg border border-border"},$e={class:"overflow-y-auto max-h-64"},es={class:"font-medium text-foreground"},ss={class:"text-sm text-muted-foreground"},ts=["onClick"];function ls(y,r,M,e,T,G){const j=U("TableHead"),p=U("TableRow"),S=U("TableHeader"),b=U("TableCell"),B=U("font-awesome-icon"),V=U("Checkbox"),P=U("TableBody"),E=U("Table"),k=U("Modal");return f(),v(h,null,[i("div",Me,[r[12]||(r[12]=i("div",{class:"flex items-center justify-between border-b border-border pb-4"},[i("h3",{class:"text-lg font-semibold text-foreground"},"AST Panel")],-1)),i("div",je,[(f(!0),v(h,null,R(e.pickedOrganisms,s=>(f(),v("div",{key:s.uid,class:"space-y-6"},[i("div",Ve,[i("div",Ee,[i("span",De,"Organism #"+C(s?.isolateNumber),1),i("span",Ye,C(s?.organism?.name),1)]),A(i("button",{onClick:t=>e.choosePanel(s),class:"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"}," Choose Panel ",8,Be),[[Y,e.canAddPanel(s)]])]),i("div",ke,[i("div",Ge,[c(E,{class:"w-full"},{default:u(()=>[c(S,null,{default:u(()=>[c(p,{class:"border-b border-border bg-muted/50"},{default:u(()=>[c(j,{class:"px-4 py-3 text-left text-sm font-medium text-muted-foreground"},{default:u(()=>[...r[2]||(r[2]=[_("Parameter",-1)])]),_:1}),(f(!0),v(h,null,R(e.getAntibiotics(s.uid),t=>(f(),w(j,{key:t,class:"px-4 py-3 text-left text-sm font-medium text-muted-foreground"},{default:u(()=>[_(C(t),1)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),c(P,null,{default:u(()=>[c(p,{class:"border-b border-border"},{default:u(()=>[c(b,{class:"px-4 py-3 text-sm font-medium text-foreground"},{default:u(()=>[...r[3]||(r[3]=[_("Guideline",-1)])]),_:1}),(f(!0),v(h,null,R(e.getAntibiotics(s.uid),t=>(f(),w(b,{key:t,class:"px-4 py-3"},{default:u(()=>[A(i("select",{"onUpdate:modelValue":d=>e.organismResults[s.uid][t].guidelineYearUid=d,onChange:d=>e.handleCellEdit(s.uid,t,"guidelineYearUid",d.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[s.uid][t].status!=="pending"},[(f(!0),v(h,null,R(e.guidelines,d=>(f(),v("option",{key:d.uid,value:d.uid},C(d.code),9,Fe))),128))],40,Ne),[[H,e.organismResults[s.uid][t].guidelineYearUid]])]),_:2},1024))),128))]),_:2},1024),c(p,{class:"border-b border-border"},{default:u(()=>[c(b,{class:"px-4 py-3 text-sm font-medium text-foreground"},{default:u(()=>[...r[4]||(r[4]=[_("AST Method",-1)])]),_:1}),(f(!0),v(h,null,R(e.getAntibiotics(s.uid),t=>(f(),w(b,{key:t,class:"px-4 py-3"},{default:u(()=>[A(i("select",{"onUpdate:modelValue":d=>e.organismResults[s.uid][t].astMethodUid=d,onChange:d=>e.handleCellEdit(s.uid,t,"astMethodUid",d.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[s.uid][t].status!=="pending"},[(f(!0),v(h,null,R(e.testMethods,d=>(f(),v("option",{key:d.uid,value:d.uid},C(d.name),9,He))),128))],40,Ie),[[H,e.organismResults[s.uid][t].astMethodUid]])]),_:2},1024))),128))]),_:2},1024),c(p,{class:"border-b border-border"},{default:u(()=>[c(b,{class:"px-4 py-3 text-sm font-medium text-foreground"},{default:u(()=>[...r[5]||(r[5]=[_("AST Value",-1)])]),_:1}),(f(!0),v(h,null,R(e.getAntibiotics(s.uid),t=>(f(),w(b,{key:t,class:"px-4 py-3"},{default:u(()=>[A(i("input",{type:"number","onUpdate:modelValue":d=>e.organismResults[s.uid][t].astValue=d,onChange:d=>e.handleCellEdit(s.uid,t,"astValue",d.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",step:"0.1",disabled:e.organismResults[s.uid][t].status!=="pending"},null,40,Le),[[W,e.organismResults[s.uid][t].astValue]])]),_:2},1024))),128))]),_:2},1024),c(p,{class:"border-b border-border"},{default:u(()=>[c(b,{class:"px-4 py-3 text-sm font-medium text-foreground"},{default:u(()=>[...r[6]||(r[6]=[_("Result",-1)])]),_:1}),(f(!0),v(h,null,R(e.getAntibiotics(s.uid),t=>(f(),w(b,{key:t,class:"px-4 py-3"},{default:u(()=>[i("div",qe,[A(i("select",{"onUpdate:modelValue":d=>e.organismResults[s.uid][t].result=d,onChange:d=>e.handleCellEdit(s.uid,t,"result",d.target.value),class:J(["w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",{"text-success":e.organismResults[s.uid][t].result?.toUpperCase()==="S","text-warning":e.organismResults[s.uid][t].result?.toUpperCase()==="I","text-destructive":e.organismResults[s.uid][t].result?.toUpperCase()==="R"}]),disabled:e.organismResults[s.uid][t].status!=="pending"},[...r[7]||(r[7]=[i("option",{value:"S"},"S",-1),i("option",{value:"I"},"I",-1),i("option",{value:"R"},"R",-1)])],42,ze),[[H,e.organismResults[s.uid][t].result]]),A(i("span",null,[c(B,{icon:"robot",class:"text-muted-foreground","aria-label":"Auto-calculated"})],512),[[Y,e.organismResults[s.uid][t].breakpointUid]])])]),_:2},1024))),128))]),_:2},1024),c(p,null,{default:u(()=>[c(b,{class:"px-4 py-3 text-sm font-medium text-foreground"},{default:u(()=>[...r[8]||(r[8]=[_("Reportable",-1)])]),_:1}),(f(!0),v(h,null,R(e.getAntibiotics(s.uid),t=>(f(),w(b,{key:t,class:"px-4 py-3"},{default:u(()=>[i("div",Ke,[c(V,{checked:e.organismResults[s.uid][t].reportable,disabled:e.organismResults[s.uid][t].status!=="pending","onUpdate:checked":d=>{e.organismResults[s.uid][t].reportable=d,e.handleCellEdit(s.uid,t,"reportable",d)}},null,8,["checked","disabled","onUpdate:checked"]),i("span",{class:J(["inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",{"bg-primary/10 text-primary":e.organismResults[s.uid][t].status==="pending","bg-warning/10 text-warning":e.organismResults[s.uid][t].status==="resulted","bg-success/10 text-success":e.organismResults[s.uid][t].status==="approved","bg-destructive/10 text-destructive":e.organismResults[s.uid][t].status==="cancelled"}])},C(e.organismResults[s.uid][t].status),3)])]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)])]),i("div",Qe,[A(c(e.Button,{key:"save",onClick:t=>e.saveAntibiotics(s.uid),color:"primary",disabled:e.savingAntibiotics},{default:u(()=>[...r[9]||(r[9]=[_(" Save Antibiotics ",-1)])]),_:1},8,["onClick","disabled"]),[[Y,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canSave(s.uid)]]),A(c(e.Button,{key:"submit",onClick:t=>e.submitAntibiotics(s.uid),color:"warning"},{default:u(()=>[...r[10]||(r[10]=[_(" Submit Antibiotics ",-1)])]),_:1},8,["onClick"]),[[Y,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canSubmit(s.uid)]]),A(c(e.Button,{key:"approve",onClick:t=>e.approveAntibiotics(s.uid),color:"success"},{default:u(()=>[...r[11]||(r[11]=[_(" Approve Antibiotics ",-1)])]),_:1},8,["onClick"]),[[Y,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canApprove(s.uid)]])])]))),128))])]),e.showModal?(f(),w(k,{key:0,onClose:r[1]||(r[1]=s=>e.showModal=!1),contentWidth:"w-1/2"},{header:u(()=>[i("h3",We,[r[13]||(r[13]=_(" Search Panel for ",-1)),i("span",Je,C(e.choiceOrganism?.organism?.name),1)])]),body:u(()=>[i("div",Xe,[i("div",Ze,[A(i("input",{"onUpdate:modelValue":r[0]||(r[0]=s=>e.searchPanelText=s),onInput:e.searchPanels,class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",placeholder:"Begin typing..."},null,544),[[W,e.searchPanelText]]),i("div",Oe,[i("div",$e,[c(E,{class:"w-full"},{default:u(()=>[c(P,null,{default:u(()=>[(f(!0),v(h,null,R(e.panels,s=>(f(),w(p,{key:s.uid,class:"border-b border-border hover:bg-muted/50 transition-colors duration-200"},{default:u(()=>[c(b,{class:"px-4 py-3"},{default:u(()=>[i("div",es,C(s.name),1),i("div",ss,C(s.antibiotics?.map(t=>t.name)?.join(", ")),1)]),_:2},1024),c(b,{class:"px-4 py-3 text-right"},{default:u(()=>[i("button",{onClick:t=>e.applyPanel(s),class:"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2"}," Apply ",8,ts)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])])])])]),_:1})):xe("",!0)],64)}const ds=ye(Pe,[["render",ls],["__file","/home/administrator/Documents/Development/beak-insights/felicity/felicity-lims/webapp/views/sample/_id/results/ASTResults.vue"]]);export{ds as default};
