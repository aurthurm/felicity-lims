import{g as Z,W as ie,f as ue,a2 as m,i as W,Y as de,r as ce,o as n,c as a,z as pe,M as J,O as t,J as l,D as ge,Z as be,L as h,N as q,F as k,H as D,C as K,a5 as Y,_ as ve}from"./index-5d85e9da.js";const me=Z`
    mutation ParseAnalyserMessage($message: String!) {
        parseAnalyserMessage(message: $message) {
            ... on AnalyzerParsedMessageType {
                __typename
                message
                seperators
            }
            ... on OperationError {
                __typename
                error
                suggestion
            }
        }
    }
`,ye=Z`
    mutation ExtractAnalyserMessage($message: String!, $driver: JSONScalar!) {
        extractAnalyserMessage(message: $message, driver: $driver) {
            ... on AnalyzerExtractedMessageType {
                __typename
                message
            }
            ... on OperationError {
                __typename
                error
                suggestion
            }
        }
    }
`,fe={class:"text-lg font-semibold text-foreground"},he={class:"space-y-4"},_e={class:""},xe={class:"flex gap-2 mt-2"},ke=["disabled"],we={key:0,class:"mt-2 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"},Me={class:"flex gap-2"},$e={key:0,class:"bg-gray-100 border border-gray-300 rounded p-3 text-xs font-mono"},Ce={class:"mb-2"},Se={class:"mb-2"},De={class:"mb-2"},Oe={class:"bg-white border border-gray-200 p-2 rounded mt-1 overflow-auto max-h-40"},je={class:"bg-white border border-gray-200 p-2 rounded mt-1 overflow-auto max-h-64"},Ee={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},Pe={class:"col-span-1 bg-white border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Fe={class:"space-y-3 font-mono text-xs"},Ne={class:"font-bold text-blue-600 mb-2"},Ae={key:0,class:"ml-4"},Re=["onClick"],Je={key:1,class:"ml-4 mt-2 font-mono text-sm break-all"},Le={key:0,class:"text-gray-400 select-none"},Te=["onClick"],Be={key:2},Ue={class:"col-span-1 bg-white border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},ze={class:"space-y-3"},He={class:"font-semibold mb-2"},Ve={key:0,class:"text-xs text-gray-500 italic"},We={key:1,class:"space-y-1"},qe={class:"font-mono text-gray-700 truncate flex-1"},Ke=["onClick"],Ye={class:"col-span-1 bg-white border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Ze={class:"mb-4"},Ge={class:"flex items-center justify-between mb-2"},Ie={class:"bg-gray-50 border border-gray-200 p-2 rounded text-xs overflow-auto max-h-[250px]"},Qe={class:"mb-4"},Xe={class:"flex items-center justify-between mb-2"},et={key:0,class:"bg-gray-50 border border-gray-200 p-2 rounded text-xs overflow-auto max-h-[200px]"},tt={key:1,class:"text-xs text-gray-500 italic"},st={key:2,class:"text-center py-12 bg-gray-50 rounded-lg border border-gray-200"},ot={class:"flex justify-end gap-2"},nt=["disabled"],at={class:"bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4"},rt={class:"mb-4 p-3 bg-gray-100 rounded"},lt={class:"text-sm font-mono text-blue-800 break-all"},it={class:"grid grid-cols-2 gap-3 mb-4 max-h-[400px] overflow-auto"},ut=["onClick"],dt={class:"font-semibold"},ct=ie({__name:"IIMapper",props:{isOpen:{type:Boolean,required:!0},instrumentInterface:{type:null,required:!0}},emits:["close","save"],setup(G,{emit:I}){const Q=G,j=I,{withClientMutation:L}=ue(),d=m(null),c=m(null),$=m(""),E=m(!1),g=m(""),b=m({result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]}),y=m(null),_=m(null),C=m(!1),T=[{key:"result",label:"Result",color:"bg-blue-100 border-blue-300"},{key:"keyword",label:"Keyword",color:"bg-red-100 border-red-300"},{key:"reference_range",label:"Reference Range",color:"bg-green-100 border-green-300"},{key:"result_date",label:"Result Date",color:"bg-purple-100 border-purple-300"},{key:"units",label:"Units",color:"bg-yellow-100 border-yellow-300"},{key:"sample_id",label:"Sample ID",color:"bg-pink-100 border-pink-300"},{key:"instrument",label:"Instrument",color:"bg-indigo-100 border-indigo-300"},{key:"result_status",label:"Result Status (F=Final, P=Preliminary)",color:"bg-orange-100 border-orange-300"}],w=W(()=>{const s={};for(const[e,r]of Object.entries(b.value)){if(r.length===0)continue;const o=r[0],u=X(o);u&&(s[e]=u)}return s}),P=m(!1),F=W(()=>{if(!d.value)return null;const s=Object.keys(d.value)[0];if(!s)return null;const e=d.value[s]?.[0];return{segmentKey:s,segment:e,fieldsKeys:e?.fields?Object.keys(e.fields):[],sampleStructure:e?.fields?.["0"]?JSON.stringify(e.fields[0],null,2):"Field 0 not found"}});function X(s){const e={segment:void 0,field:void 0,component:void 0,subcomponent:void 0},r=s.match(/^(\w+)\[(\d+)\]/);if(!r)return null;e.segment=r[1];const o=s.match(/\.fields\.(\d+)/);o&&(e.field=parseInt(o[1]));const u=s.match(/\.components\.(\d+)/);u&&(e.component=parseInt(u[1]));const v=s.match(/\.subcomponents\.(\d+)/);return v&&(e.subcomponent=parseInt(v[1])),Object.keys(e).forEach(p=>{e[p]===void 0&&delete e[p]}),e}async function ee(){if(!$.value.trim()){g.value="Please paste a message first";return}E.value=!0,g.value="";try{L(me,{message:$.value},"parseAnalyserMessage").then(s=>{console.log(s),s&&s.message?(c.value=s.seperators,d.value=s.message,b.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},y.value=null):(g.value="Failed to parse message",d.value=null,c.value=null)})}catch(s){console.error("Parse error:",s),g.value="Failed to parse message",d.value=null,c.value=null}finally{E.value=!1}}function te(s,e,r){const o=[];return(s.raw||"").split(c.value?.field).forEach((p,i)=>{const N=s.fields?.[String(i)];if(i>0&&o.push({type:"separator",content:c.value?.field}),N?.repeats){const f=p.split(c.value?.repeat),M=N.repeats;f.forEach((S,x)=>{x>0&&o.push({type:"separator",content:c.value?.repeat});const O=`${e}[${r}].fields.${i}.repeats[${x}].raw`;x<M.length&&M[x]?.components?S.split(c.value?.component).forEach((R,V)=>{V>0&&o.push({type:"separator",content:c.value?.component});const le=`${e}[${r}].fields.${i}.repeats[${x}].components.${V+1}.raw`;o.push({type:"button",content:R,path:le})}):o.push({type:"button",content:S,path:O})})}else{const f=p.split(c.value?.component);if(f.length>1)f.forEach((M,S)=>{S>0&&o.push({type:"separator",content:c.value?.component});const x=M.split(c.value?.subcomponent);if(x.length>1)x.forEach((O,A)=>{A>0&&o.push({type:"separator",content:c.value?.subcomponent});const R=`${e}[${r}].fields.${i}.components.${S+1}.subcomponents.${A+1}`;o.push({type:"button",content:O,path:R})});else{const O=`${e}[${r}].fields.${i}.components.${S+1}`;o.push({type:"button",content:M,path:O})}});else{const M=i===0?`${e}[${r}]`:`${e}[${r}].fields.${i}`;o.push({type:"button",content:p,path:M})}}}),o}function B(s){_.value=s,C.value=!0}function U(s,e){const r=s.currentTarget;r&&(e?(r.style.backgroundColor="rgba(253, 224, 71, 1)",r.style.borderColor="rgb(234, 179, 8)",r.style.fontWeight="500"):(r.style.backgroundColor="rgba(253, 224, 71, 0)",r.style.borderColor="rgba(209, 213, 219, 0.5)",r.style.fontWeight="400"))}function se(s){_.value&&(b.value[s]=[...b.value[s],_.value],C.value=!1,_.value=null)}function oe(s,e){b.value[s]=b.value[s].filter((r,o)=>o!==e)}function ne(){if(!d.value){g.value="Please parse a message first.";return}L(ye,{message:$.value,driver:JSON.stringify(w.value)},"extractAnalyserMessage").then(s=>{console.log(s),s&&s.message?(y.value=s.message,g.value=""):(g.value="Failed to extract data",y.value=null)})}function z(){const s={driver:w.value,timestamp:new Date().toISOString()},e=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),r=URL.createObjectURL(e),o=document.createElement("a");o.href=r,o.download="driver-mapping.json",o.click()}function ae(){if(!y.value)return;const s=new Blob([JSON.stringify(y.value,null,2)],{type:"application/json"}),e=URL.createObjectURL(s),r=document.createElement("a");r.href=e,r.download="extracted-data.json",r.click()}function H(){$.value="",d.value=null,y.value=null,g.value="",b.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},_.value=null,C.value=!1}function re(){j("save",w.value),j("close")}return de(()=>Q.isOpen,s=>{s||H()}),(s,e)=>{const r=ce("fel-modal");return n(),a(k,null,[s.isOpen?(n(),pe(r,{key:0,onClose:e[5]||(e[5]=o=>j("close")),contentWidth:"w-full max-w-7xl"},{header:J(()=>[t("h3",fe," Driver Mapper - "+l(s.instrumentInterface?.laboratoryInstrument?.labName||"Instrument"),1)]),body:J(()=>[t("div",he,[t("div",_e,[e[8]||(e[8]=t("h4",{class:"text-md font-semibold text-foreground mb-3"},"Paste ASTM/HL7 Message",-1)),ge(t("textarea",{"onUpdate:modelValue":e[0]||(e[0]=o=>$.value=o),placeholder:"Paste your raw ASTM/HL7 message here",class:"w-full h-32 p-3 border border-input rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[be,$.value]]),t("div",xe,[t("button",{onClick:ee,disabled:E.value,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"},l(E.value?"Parsing...":"Parse Message"),9,ke),d.value?(n(),a("button",{key:0,onClick:ne,class:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"}," Extract Data ")):h("",!0),d.value&&Object.values(b.value).some(o=>o.length>0)?(n(),a("button",{key:1,onClick:z,class:"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition"}," Save Mappings ")):h("",!0),d.value?(n(),a("button",{key:2,onClick:H,class:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition"}," Clear ")):h("",!0)]),g.value?(n(),a("div",we," âš ï¸ "+l(g.value),1)):h("",!0)]),t("div",Me,[t("button",{onClick:e[1]||(e[1]=o=>P.value=!P.value),class:"px-3 py-1 text-xs bg-gray-400 text-white rounded hover:bg-gray-500 transition"},l(P.value?"Hide":"Show")+" Debug Info ",1)]),P.value&&F.value?(n(),a("div",$e,[t("div",Ce,[e[9]||(e[9]=t("strong",null,"First Segment:",-1)),q(" "+l(F.value.segmentKey),1)]),t("div",Se,[e[10]||(e[10]=t("strong",null,"Field Keys:",-1)),q(" "+l(F.value.fieldsKeys.join(", ")),1)]),t("div",De,[e[11]||(e[11]=t("strong",null,"Sample Field Structure (Field 0):",-1)),t("pre",Oe,l(F.value.sampleStructure),1)]),t("div",null,[e[12]||(e[12]=t("strong",null,"Full Parsed Message:",-1)),t("pre",je,l(JSON.stringify(d.value,null,2)),1)])])):h("",!0),d.value?(n(),a("div",Ee,[t("div",Pe,[e[14]||(e[14]=t("h4",{class:"text-md font-semibold mb-3 sticky top-0 bg-white pb-2 border-b"},"Parsed Message Segments",-1)),t("div",Fe,[(n(!0),a(k,null,D(d.value,(o,u)=>(n(),a("div",{key:u,class:"mb-6"},[(n(!0),a(k,null,D(o,(v,p)=>(n(),a("div",{key:`${u}-${p}`,class:"mb-3"},[t("div",Ne,l(u)+":",1),v.fields?(n(),a("div",Je,[(n(!0),a(k,null,D(te(v,u,p),(i,N)=>(n(),a(k,{key:`fld-${u}-${p}-${N}`},[i.type==="separator"?(n(),a("span",Le,l(i.content),1)):i.type==="button"&&i.path?(n(),a("button",{key:1,type:"button",onClick:K(f=>B(i.path),["stop"]),onMouseenter:e[2]||(e[2]=f=>U(f,!0)),onMouseleave:e[3]||(e[3]=f=>U(f,!1)),class:"inline px-1.5 py-0.5 rounded cursor-pointer transition-all duration-200 font-mono text-sm",style:{"background-color":"rgba(253, 224, 71, 0)",border:"1px solid rgba(209, 213, 219, 0.5)"}},l(i.content),41,Te)):(n(),a("span",Be,l(i.content),1))],64))),128))])):(n(),a("div",Ae,[t("button",{onClick:i=>B(`${u}[${p}].raw`),class:"hover:bg-yellow-200 px-1 rounded transition-colors"},' "'+l(v.raw)+'" ',9,Re)]))]))),128))]))),128)),e[13]||(e[13]=t("div",{class:"p-2 bg-gray-100 rounded text-xs text-gray-600 mt-2"}," ðŸ’¡ Click on any field to map it to a target variable ",-1))])]),t("div",Ue,[e[15]||(e[15]=t("h4",{class:"text-md font-semibold mb-3 sticky top-0 bg-white pb-2 border-b"},"Field Mappings",-1)),t("div",ze,[(n(),a(k,null,D(T,o=>t("div",{key:o.key,class:Y(["border-2 rounded-lg p-3",o.color])},[t("h5",He,l(o.label),1),b.value[o.key].length===0?(n(),a("div",Ve," No mappings. Click a field in the segments. ")):(n(),a("div",We,[(n(!0),a(k,null,D(b.value[o.key],(u,v)=>(n(),a("div",{key:v,class:"flex items-center justify-between bg-white rounded p-2 text-xs"},[t("code",qe,l(u),1),t("button",{onClick:p=>oe(o.key,v),class:"p-1 hover:bg-red-100 rounded ml-2 text-red-600",title:"Remove mapping"}," âœ• ",8,Ke)]))),128))]))],2)),64))])]),t("div",Ye,[t("div",Ze,[t("div",Ge,[e[16]||(e[16]=t("h5",{class:"text-sm font-semibold text-gray-700"},"Driver Configuration:",-1)),Object.keys(w.value).length>0?(n(),a("button",{key:0,onClick:z,class:"px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition",title:"Download driver configuration"}," Download ")):h("",!0)]),t("pre",Ie,l(JSON.stringify(w.value,null,2)),1)]),t("div",Qe,[t("div",Xe,[e[17]||(e[17]=t("h5",{class:"text-sm font-semibold text-gray-700"},"Extracted Data:",-1)),y.value?(n(),a("button",{key:0,onClick:ae,class:"px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition",title:"Download extracted data"}," Download ")):h("",!0)]),y.value?(n(),a("pre",et,"                "+l(JSON.stringify(y.value,null,2))+`
              `,1)):(n(),a("p",tt,'Click "Extract Data" to see results'))])])])):(n(),a("div",st,e[18]||(e[18]=[t("p",{class:"text-gray-500"},'Paste a message and click "Parse Message" to begin',-1)])))])]),footer:J(()=>[t("div",ot,[t("button",{onClick:e[4]||(e[4]=o=>j("close")),class:"px-4 py-2 border border-input rounded-md hover:bg-accent hover:text-accent-foreground transition"}," Cancel "),t("button",{onClick:re,disabled:!w.value||Object.keys(w.value).length===0,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"}," Save Driver Mapping ",8,nt)])]),_:1})):h("",!0),C.value&&_.value?(n(),a("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e[7]||(e[7]=K(o=>C.value=!1,["self"]))},[t("div",at,[e[20]||(e[20]=t("h3",{class:"text-xl font-bold mb-4"},"Map Field to Target Variable",-1)),t("div",rt,[e[19]||(e[19]=t("p",{class:"text-sm text-gray-600 mb-1"},"Selected Path:",-1)),t("code",lt,l(_.value),1)]),t("div",it,[(n(),a(k,null,D(T,o=>t("button",{key:o.key,onClick:u=>se(o.key),class:Y(["p-3 border-2 rounded-lg text-left hover:shadow-md transition",o.color])},[t("span",dt,l(o.label),1)],10,ut)),64))]),t("button",{onClick:e[6]||(e[6]=o=>{C.value=!1,_.value=null}),class:"w-full px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition"}," Cancel ")])])):h("",!0)],64)}}});const gt=ve(ct,[["__scopeId","data-v-f3a470d0"],["__file","/home/aurthurm/Documents/Development/felicity/felicity-lims/webapp/components/IIMapper.vue"]]);export{gt as default};
