import{d as k,u as B,bp as E,Y as J,aw as T,aB as z,a7 as F,_ as V,aF as q,c as d,o as c,z as s,D as K,a as L,F as v,H as D,I as g,K as N,M as R}from"./index-OdhKCqIc.js";import{u as G}from"./user-DYsgscqA.js";import{p as A}from"./index-CXV6PIcj.js";import{B as H}from"./index-Dj97WNKd.js";import{C as I,a as M}from"./CardContent-Ds7WIX9a.js";import{S as P}from"./Spinner-Bl8RfjFA.js";const{withClientQuery:Q}=B(),Y=k("auditlog",{state:()=>({auditLogs:[],fetchingAudits:!1,error:null}),getters:{getAuditLogs:i=>i.auditLogs,isLoading:i=>i.fetchingAudits,hasError:i=>i.error!==null},actions:{async fetchAuditLogs(i){this.fetchingAudits=!0,this.error=null;try{const e=await Q(E,i,"auditLogsFilter");e&&Array.isArray(e)?this.auditLogs=e.map(b=>{const t={...b};if(typeof t.stateAfter=="string")try{t.stateAfter=JSON.parse(t.stateAfter)}catch{}if(typeof t.stateBefore=="string")try{t.stateBefore=JSON.parse(t.stateBefore)}catch{}if(typeof t.extras=="string")try{t.extras=JSON.parse(t.extras)}catch{}return t}):this.auditLogs=[]}catch(e){this.error=e instanceof Error?e.message:"Unknown error occurred"}finally{this.fetchingAudits=!1}},resetLogs(){this.auditLogs=[],this.error=null}}}),W=J({__name:"AuditLog",props:{targetUid:{type:String,required:!1,default:void 0},targetType:{type:String,required:!1,default:void 0}},setup(i,{expose:e}){e();const b=i,{targetType:t,targetUid:w}=T(b),S=G(),h=Y();h.resetLogs();const{auditLogs:l,fetchingAudits:u}=z(h);S.fetchUsers({}),h.fetchAuditLogs({targetType:t?.value,targetUid:w?.value});const C=F(()=>S.getUsers);function a(_){const m=C.value?.find(x=>(x.uid||x.userUid)?.toString()===_?.toString());return m?.userName||m?.firstName||m?.lastName||""}function O(_){switch(_){case 1:return"created";case 2:return"updated";case 3:return"deleted";default:return""}}function j(_){const m=new Set;return Object.entries(_?.stateBefore||{}).forEach(([x,r])=>{Object.entries(_?.stateAfter||{}).forEach(([f,p])=>{if(x===f&&r!==p){let y=f,n=r,o=p;f==="updated_by_uid"?(y="updated_by",n=a(r),o=a(p)):f==="submitted_by_uid"?(y="submitted_by",n=a(r),o=a(p)):f==="verified_by_uid"?(y="verified_by",n=a(r),o=a(p)):f==="updated_at"?(y="updated_on",n=A(r),o=A(p)):f==="cancelled_by_uid"?(y="cancelled_by",n=a(r),o=a(p)):f==="received_by_uid"&&(y="received_by",n=a(r),o=a(p)),m.add({key:y,old:n!=null&&typeof n=="object"?JSON.stringify(n):String(n||"None"),new:o!=null&&typeof o=="object"?JSON.stringify(o):String(o||"None")})}})}),Object.entries(_?.extras||{}).forEach(([x,r])=>{r!=null&&r!==""&&m.add({key:x,raw:typeof r=="object"?JSON.stringify(r):String(r)})}),Array.from(m)}const U={props:b,targetType:t,targetUid:w,userStore:S,auditLogStore:h,auditLogs:l,fetchingAudits:u,users:C,translateUser:a,translateAction:O,changes:j,get parseDate(){return A},get Badge(){return H},get Card(){return M},get CardContent(){return I},get Spinner(){return P}};return Object.defineProperty(U,"__isScriptSetup",{enumerable:!1,value:!0}),U}}),X={class:"relative mt-4",role:"log","aria-label":"Audit log"},Z={key:0,class:"py-4 text-center"},$={class:"inline-flex items-center gap-2"},tt={key:1,initial:{opacity:0,y:100},enter:{opacity:1,y:0,scale:1},variants:{custom:{scale:2}},delay:200,class:"list-none m-0 p-0 space-y-4"},et={class:"flex items-center mb-2"},st={class:"ml-4 font-medium flex flex-wrap items-center gap-2"},rt={class:"text-foreground"},at={class:"text-foreground"},it={class:"text-muted-foreground"},nt={class:"col-span-1"},ot={class:"text-sm text-muted-foreground"},dt={key:0,class:"col-span-3"},ct={class:"text-xs text-muted-secondary"},lt={key:1,class:"col-span-3 flex items-center gap-2"},ut={class:"text-xs text-destructive line-through"},ft={class:"text-xs text-primary"};function pt(i,e,b,t,w,S){const h=q("motion");return c(),d("div",X,[e[3]||(e[3]=s("div",{class:"border-r-2 border-border border-dotted absolute h-full top-0 z-0",style:{left:"7px"},"aria-hidden":"true"},null,-1)),t.fetchingAudits?(c(),d("div",Z,[s("span",$,[L(t.Spinner,{class:"size-4"}),e[0]||(e[0]=s("span",{class:"text-sm"},"Fetching audit logs ...",-1))])])):K((c(),d("ul",tt,[(c(!0),d(v,null,D(t.auditLogs,l=>(c(),d("li",{key:l.uid,class:"relative"},[s("div",et,[e[1]||(e[1]=s("div",{class:"bg-accent rounded-full h-4 w-4 border-border border-2 z-10","aria-hidden":"true"},null,-1)),s("div",st,[s("span",rt,g(t.translateUser(l?.userUid)),1),L(t.Badge,{variant:"secondary",class:"capitalize"},{default:N(()=>[R(g(t.translateAction(l?.action)),1)]),_:2},1024),s("span",at,g(l?.targetType),1),s("span",it," on "+g(t.parseDate(l?.stateAfter?.updated_at)),1)])]),L(t.Card,{class:"ml-10"},{default:N(()=>[L(t.CardContent,{class:"py-3 space-y-2"},{default:N(()=>[(c(!0),d(v,null,D(t.changes(l),u=>(c(),d("div",{key:u.key,class:"grid grid-cols-4 gap-2 items-center"},[s("span",nt,[s("span",ot,g(u?.key),1)]),u?.raw?(c(),d("span",dt,[s("span",ct,g(u?.raw),1)])):(c(),d("span",lt,[s("span",ut,g(u?.old),1),e[2]||(e[2]=s("span",{class:"text-xs text-muted-foreground","aria-hidden":"true"},"â†’",-1)),s("span",ft,g(u?.new),1)]))]))),128))]),_:2},1024)]),_:2},1024)]))),128))])),[[h]])])}const bt=V(W,[["render",pt],["__file","/home/administrator/Documents/Development/beak-insights/felicity/felicity-lims/webapp/components/audit/AuditLog.vue"]]);export{bt as default};
