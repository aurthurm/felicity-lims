import{d as D,f as j,b5 as E,a0 as T,t as k,as as V,h as C,_ as q,r as z,aa as B,c as l,o as u,A as r,F as K,a as P,J as O,K as U,P as v,L as g}from"./index-Cdc6vSVw.js";import{u as R}from"./user-DvEjaZsO.js";import{p as A}from"./index-DUkUXZe3.js";const{withClientQuery:G}=j(),Q=D("auditlog",{state:()=>({auditLogs:[],fetchingAudits:!1,error:null}),getters:{getAuditLogs:a=>a.auditLogs,isLoading:a=>a.fetchingAudits,hasError:a=>a.error!==null},actions:{async fetchAuditLogs(a){this.fetchingAudits=!0,this.error=null;try{const t=await G(E,a,"auditLogsFilter");t&&Array.isArray(t)?this.auditLogs=t.map(S=>{const e={...S};if(typeof e.stateAfter=="string")try{e.stateAfter=JSON.parse(e.stateAfter)}catch(d){console.error("Failed to parse stateAfter JSON:",d)}if(typeof e.stateBefore=="string")try{e.stateBefore=JSON.parse(e.stateBefore)}catch(d){console.error("Failed to parse stateBefore JSON:",d)}if(typeof e.extras=="string")try{e.extras=JSON.parse(e.extras)}catch(d){console.error("Failed to parse extras JSON:",d)}return e}):this.auditLogs=[]}catch(t){this.error=t instanceof Error?t.message:"Unknown error occurred",console.error("Error fetching audit logs:",t)}finally{this.fetchingAudits=!1}},resetLogs(){this.auditLogs=[],this.error=null}}}),H=T({__name:"FelAuditLog",props:{targetUid:{type:String,required:!1,default:void 0},targetType:{type:String,required:!1,default:void 0}},setup(a,{expose:t}){t();const S=a,{targetType:e,targetUid:d}=k(S),L=R(),b=Q();b.resetLogs();const{auditLogs:N,fetchingAudits:f}=V(b);L.fetchUsers({}),b.fetchAuditLogs({targetType:e?.value,targetUid:d?.value});const c=C(()=>L.getUsers);function o(y){const h=c.value?.find(x=>(x.uid||x.userUid)?.toString()===y?.toString());return h?.userName||h?.firstName||h?.lastName||""}function F(y){switch(y){case 1:return"created";case 2:return"updated";case 3:return"deleted";default:return""}}function J(y){const h=new Set;return Object.entries(y?.stateBefore||{}).forEach(([x,s])=>{Object.entries(y?.stateAfter||{}).forEach(([p,_])=>{if(x===p&&s!==_){let m=p,i=s,n=_;p==="updated_by_uid"?(m="updated_by",i=o(s),n=o(_)):p==="submitted_by_uid"?(m="submitted_by",i=o(s),n=o(_)):p==="verified_by_uid"?(m="verified_by",i=o(s),n=o(_)):p==="updated_at"?(m="updated_on",i=A(s),n=A(_)):p==="cancelled_by_uid"?(m="cancelled_by",i=o(s),n=o(_)):p==="received_by_uid"&&(m="received_by",i=o(s),n=o(_)),h.add({key:m,old:i!=null&&typeof i=="object"?JSON.stringify(i):String(i||"None"),new:n!=null&&typeof n=="object"?JSON.stringify(n):String(n||"None")})}})}),Object.entries(y?.extras||{}).forEach(([x,s])=>{s!=null&&s!==""&&h.add({key:x,raw:typeof s=="object"?JSON.stringify(s):String(s)})}),Array.from(h)}const w={props:S,targetType:e,targetUid:d,userStore:L,auditLogStore:b,auditLogs:N,fetchingAudits:f,users:c,translateUser:o,translateAction:F,changes:J,get parseDate(){return A}};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}}),I={class:"relative mt-4",role:"log","aria-label":"Audit log"},M={key:0,class:"py-4 text-center"},W={key:1,initial:{opacity:0,y:100},enter:{opacity:1,y:0,scale:1},variants:{custom:{scale:2}},delay:200,class:"list-none m-0 p-0 space-y-4"},X={class:"flex items-center mb-2"},Y={class:"ml-4 font-medium"},Z={class:"text-foreground"},$={class:"text-primary"},ee={class:"text-muted-foreground"},te={class:"ml-12 space-y-2"},se={class:"col-span-1"},re={class:"text-sm text-muted-foreground"},oe={key:0,class:"col-span-3"},ae={class:"text-xs text-muted-secondary"},ie={key:1,class:"col-span-3 flex items-center gap-2"},ne={class:"text-xs text-destructive line-through"},de={class:"text-xs text-primary"};function ce(a,t,S,e,d,L){const b=z("fel-loader"),N=B("motion");return u(),l("div",I,[t[2]||(t[2]=r("div",{class:"border-r-2 border-border border-dotted absolute h-full top-0 z-0",style:{left:"7px"},"aria-hidden":"true"},null,-1)),e.fetchingAudits?(u(),l("div",M,[P(b,{message:"Fetching audit logs ..."})])):K((u(),l("ul",W,[(u(!0),l(O,null,U(e.auditLogs,f=>(u(),l("li",{key:f.uid,class:"relative"},[r("div",X,[t[0]||(t[0]=r("div",{class:"bg-accent rounded-full h-4 w-4 border-border border-2 z-10","aria-hidden":"true"},null,-1)),r("div",Y,[r("span",Z,[v(g(e.translateUser(f?.userUid))+" ",1),r("span",$,g(e.translateAction(f?.action)),1),v(" "+g(f?.targetType),1)]),r("span",ee," on "+g(e.parseDate(f?.stateAfter?.updated_at)),1)])]),r("div",te,[(u(!0),l(O,null,U(e.changes(f),c=>(u(),l("div",{key:c.key,class:"grid grid-cols-4 gap-2 items-center"},[r("span",se,[r("span",re,g(c?.key),1)]),c?.raw?(u(),l("span",oe,[r("span",ae,g(c?.raw),1)])):(u(),l("span",ie,[r("span",ne,g(c?.old),1),t[1]||(t[1]=r("span",{class:"text-xs text-muted-foreground","aria-hidden":"true"},"â†’",-1)),r("span",de,g(c?.new),1)]))]))),128))])]))),128))])),[[N]])])}const pe=q(H,[["render",ce],["__file","/home/aurthurm/Documents/Development/felicity/felicity-lims/webapp/components/audit/FelAuditLog.vue"]]);export{pe as default};
