import{k as G,a0 as ue,f as pe,a7 as h,h as q,a5 as ge,_ as be,r as me,c as i,o as a,C as fe,E as _,N as I,A as t,F as ve,a2 as ye,L as c,P as K,J as M,K as D,D as W,Q}from"./index-Cdc6vSVw.js";const he=G`
    mutation ParseAnalyserMessage($message: String!) {
  parseAnalyserMessage(message: $message) {
    ... on AnalyzerParsedMessageType {
      __typename
      message
      seperators
    }
    ... on OperationError {
      __typename
      error
      suggestion
    }
  }
}
    `,xe=G`
    mutation ExtractAnalyserMessage($message: String!, $driver: JSONScalar!) {
  extractAnalyserMessage(message: $message, driver: $driver) {
    ... on AnalyzerExtractedMessageType {
      __typename
      message
    }
    ... on OperationError {
      __typename
      error
      suggestion
    }
  }
}
    `,_e=ue({__name:"IIMapper",props:{isOpen:{type:Boolean,required:!0},instrumentInterface:{type:null,required:!0}},emits:["close","save"],setup(J,{expose:s,emit:P}){s();const e=J,F=P,{withClientMutation:j}=pe(),b=h(null),n=h(null),p=h(""),f=h(!1),g=h(""),u=h({result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]}),x=h(null),m=h(null),A=h(!1),X=[{key:"result",label:"Result",color:"bg-blue-100 border-blue-300"},{key:"keyword",label:"Keyword",color:"bg-red-100 border-red-300"},{key:"reference_range",label:"Reference Range",color:"bg-green-100 border-green-300"},{key:"result_date",label:"Result Date",color:"bg-purple-100 border-purple-300"},{key:"units",label:"Units",color:"bg-yellow-100 border-yellow-300"},{key:"sample_id",label:"Sample ID",color:"bg-pink-100 border-pink-300"},{key:"instrument",label:"Instrument",color:"bg-indigo-100 border-indigo-300"},{key:"result_status",label:"Result Status (F=Final, P=Preliminary)",color:"bg-orange-100 border-orange-300"}],N=q(()=>{const o={};for(const[r,d]of Object.entries(u.value)){if(d.length===0)continue;const l=d[0],v=T(l);v&&(o[r]=v)}return o}),Y=h(!1),Z=q(()=>{if(!b.value)return null;const o=Object.keys(b.value)[0];if(!o)return null;const r=b.value[o]?.[0];return{segmentKey:o,segment:r,fieldsKeys:r?.fields?Object.keys(r.fields):[],sampleStructure:r?.fields?.["0"]?JSON.stringify(r.fields[0],null,2):"Field 0 not found"}});function T(o){const r={segment:void 0,field:void 0,component:void 0,subcomponent:void 0},d=o.match(/^(\w+)\[(\d+)\]/);if(!d)return null;r.segment=d[1];const l=o.match(/\.fields\.(\d+)/);l&&(r.field=parseInt(l[1]));const v=o.match(/\.components\.(\d+)/);v&&(r.component=parseInt(v[1]));const O=o.match(/\.subcomponents\.(\d+)/);return O&&(r.subcomponent=parseInt(O[1])),Object.keys(r).forEach(w=>{r[w]===void 0&&delete r[w]}),r}async function $(){if(!p.value.trim()){g.value="Please paste a message first";return}f.value=!0,g.value="";try{j(he,{message:p.value},"parseAnalyserMessage").then(o=>{console.log(o),o&&o.message?(n.value=o.seperators,b.value=o.message,u.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},x.value=null):(g.value="Failed to parse message",b.value=null,n.value=null)})}catch(o){console.error("Parse error:",o),g.value="Failed to parse message",b.value=null,n.value=null}finally{f.value=!1}}function ee(o,r,d){const l=[];return(o.raw||"").split(n.value?.field).forEach((w,y)=>{const V=o.fields?.[String(y)];if(y>0&&l.push({type:"separator",content:n.value?.field}),V?.repeats){const L=w.split(n.value?.repeat),C=V.repeats;L.forEach((S,k)=>{k>0&&l.push({type:"separator",content:n.value?.repeat});const E=`${r}[${d}].fields.${y}.repeats[${k}].raw`;k<C.length&&C[k]?.components?S.split(n.value?.component).forEach((B,z)=>{z>0&&l.push({type:"separator",content:n.value?.component});const ce=`${r}[${d}].fields.${y}.repeats[${k}].components.${z+1}.raw`;l.push({type:"button",content:B,path:ce})}):l.push({type:"button",content:S,path:E})})}else{const L=w.split(n.value?.component);if(L.length>1)L.forEach((C,S)=>{S>0&&l.push({type:"separator",content:n.value?.component});const k=C.split(n.value?.subcomponent);if(k.length>1)k.forEach((E,R)=>{R>0&&l.push({type:"separator",content:n.value?.subcomponent});const B=`${r}[${d}].fields.${y}.components.${S+1}.subcomponents.${R+1}`;l.push({type:"button",content:E,path:B})});else{const E=`${r}[${d}].fields.${y}.components.${S+1}`;l.push({type:"button",content:C,path:E})}});else{const C=y===0?`${r}[${d}]`:`${r}[${d}].fields.${y}`;l.push({type:"button",content:w,path:C})}}}),l}function te(o){m.value=o,A.value=!0}function oe(o,r){const d=o.currentTarget;d&&(r?(d.style.backgroundColor="rgba(253, 224, 71, 1)",d.style.borderColor="rgb(234, 179, 8)",d.style.fontWeight="500"):(d.style.backgroundColor="rgba(253, 224, 71, 0)",d.style.borderColor="rgba(209, 213, 219, 0.5)",d.style.fontWeight="400"))}function se(o){m.value&&(u.value[o]=[...u.value[o],m.value],A.value=!1,m.value=null)}function ne(o,r){u.value[o]=u.value[o].filter((d,l)=>l!==r)}function re(o,r){const d=r.split(".");let l=o;for(const v of d){if(l==null)return null;if(v.includes("[")){const[O,w]=v.split("["),y=parseInt(w.replace("]",""));l=l[O]?.[y]}else l=l[v]}return l}function ae(){if(!b.value){g.value="Please parse a message first.";return}j(xe,{message:p.value,driver:JSON.stringify(N.value)},"extractAnalyserMessage").then(o=>{console.log(o),o&&o.message?(x.value=o.message,g.value=""):(g.value="Failed to extract data",x.value=null)})}function le(){const o={driver:N.value,timestamp:new Date().toISOString()},r=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),d=URL.createObjectURL(r),l=document.createElement("a");l.href=d,l.download="driver-mapping.json",l.click()}function ie(){if(!x.value)return;const o=new Blob([JSON.stringify(x.value,null,2)],{type:"application/json"}),r=URL.createObjectURL(o),d=document.createElement("a");d.href=r,d.download="extracted-data.json",d.click()}function U(){p.value="",b.value=null,x.value=null,g.value="",u.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},m.value=null,A.value=!1}function de(){F("save",N.value),F("close")}ge(()=>e.isOpen,o=>{o||U()});const H={props:e,emit:F,withClientMutation:j,parsedMessage:b,parsedSeparators:n,rawInput:p,isLoading:f,parseError:g,mappings:u,extractedData:x,selectedPath:m,showMappingModal:A,targetFields:X,driverMapping:N,showDebugInfo:Y,debugInfo:Z,parsePathToConfig:T,handleParse:$,renderSegmentFields:ee,handleFieldClick:te,handleButtonHover:oe,addMapping:se,removeMapping:ne,extractValues:re,applyMappings:ae,downloadMappingConfig:le,downloadExtractedData:ie,clearAll:U,saveDriverMapping:de};return Object.defineProperty(H,"__isScriptSetup",{enumerable:!1,value:!0}),H}}),we={class:"text-lg font-semibold text-foreground"},ke={class:"space-y-4"},Me={class:""},Ce={class:"flex gap-2 mt-2"},Se=["disabled"],De={key:0,class:"mt-2 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"},Oe={class:"flex gap-2"},Ee={key:0,class:"bg-gray-100 border border-gray-300 rounded p-3 text-xs font-mono"},Pe={class:"mb-2"},Fe={class:"mb-2"},je={class:"mb-2"},Ae={class:"bg-white border border-gray-200 p-2 rounded mt-1 overflow-auto max-h-40"},Ne={class:"bg-white border border-gray-200 p-2 rounded mt-1 overflow-auto max-h-64"},Le={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},Re={class:"col-span-1 bg-white border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Be={class:"space-y-3 font-mono text-xs"},Ie={class:"font-bold text-blue-600 mb-2"},Je={key:0,class:"ml-4"},Te=["onClick"],Ue={key:1,class:"ml-4 mt-2 font-mono text-sm break-all"},He={key:0,class:"text-gray-400 select-none"},Ve=["onClick"],ze={key:2},qe={class:"col-span-1 bg-white border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Ke={class:"space-y-3"},We={class:"font-semibold mb-2"},Qe={key:0,class:"text-xs text-gray-500 italic"},Ge={key:1,class:"space-y-1"},Xe={class:"font-mono text-gray-700 truncate flex-1"},Ye=["onClick"],Ze={class:"col-span-1 bg-white border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},$e={class:"mb-4"},et={class:"flex items-center justify-between mb-2"},tt={class:"bg-gray-50 border border-gray-200 p-2 rounded text-xs overflow-auto max-h-[250px]"},ot={class:"mb-4"},st={class:"flex items-center justify-between mb-2"},nt={key:0,class:"bg-gray-50 border border-gray-200 p-2 rounded text-xs overflow-auto max-h-[200px]"},rt={key:1,class:"text-xs text-gray-500 italic"},at={key:2,class:"text-center py-12 bg-gray-50 rounded-lg border border-gray-200"},lt={class:"flex justify-end gap-2"},it=["disabled"],dt={class:"bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4"},ct={class:"mb-4 p-3 bg-gray-100 rounded"},ut={class:"text-sm font-mono text-blue-800 break-all"},pt={class:"grid grid-cols-2 gap-3 mb-4 max-h-[400px] overflow-auto"},gt=["onClick"],bt={class:"font-semibold"};function mt(J,s,P,e,F,j){const b=me("fel-modal");return a(),i(M,null,[P.isOpen?(a(),fe(b,{key:0,onClose:s[5]||(s[5]=n=>e.emit("close")),contentWidth:"w-full max-w-7xl"},{header:I(()=>[t("h3",we," Driver Mapper - "+c(P.instrumentInterface?.laboratoryInstrument?.labName||"Instrument"),1)]),body:I(()=>[t("div",ke,[t("div",Me,[s[8]||(s[8]=t("h4",{class:"text-md font-semibold text-foreground mb-3"},"Paste ASTM/HL7 Message",-1)),ve(t("textarea",{"onUpdate:modelValue":s[0]||(s[0]=n=>e.rawInput=n),placeholder:"Paste your raw ASTM/HL7 message here",class:"w-full h-32 p-3 border border-input rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[ye,e.rawInput]]),t("div",Ce,[t("button",{onClick:e.handleParse,disabled:e.isLoading,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"},c(e.isLoading?"Parsing...":"Parse Message"),9,Se),e.parsedMessage?(a(),i("button",{key:0,onClick:e.applyMappings,class:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"}," Extract Data ")):_("",!0),e.parsedMessage&&Object.values(e.mappings).some(n=>n.length>0)?(a(),i("button",{key:1,onClick:e.downloadMappingConfig,class:"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition"}," Save Mappings ")):_("",!0),e.parsedMessage?(a(),i("button",{key:2,onClick:e.clearAll,class:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition"}," Clear ")):_("",!0)]),e.parseError?(a(),i("div",De," âš ï¸ "+c(e.parseError),1)):_("",!0)]),t("div",Oe,[t("button",{onClick:s[1]||(s[1]=n=>e.showDebugInfo=!e.showDebugInfo),class:"px-3 py-1 text-xs bg-gray-400 text-white rounded hover:bg-gray-500 transition"},c(e.showDebugInfo?"Hide":"Show")+" Debug Info ",1)]),e.showDebugInfo&&e.debugInfo?(a(),i("div",Ee,[t("div",Pe,[s[9]||(s[9]=t("strong",null,"First Segment:",-1)),K(" "+c(e.debugInfo.segmentKey),1)]),t("div",Fe,[s[10]||(s[10]=t("strong",null,"Field Keys:",-1)),K(" "+c(e.debugInfo.fieldsKeys.join(", ")),1)]),t("div",je,[s[11]||(s[11]=t("strong",null,"Sample Field Structure (Field 0):",-1)),t("pre",Ae,c(e.debugInfo.sampleStructure),1)]),t("div",null,[s[12]||(s[12]=t("strong",null,"Full Parsed Message:",-1)),t("pre",Ne,c(JSON.stringify(e.parsedMessage,null,2)),1)])])):_("",!0),e.parsedMessage?(a(),i("div",Le,[t("div",Re,[s[14]||(s[14]=t("h4",{class:"text-md font-semibold mb-3 sticky top-0 bg-white pb-2 border-b"},"Parsed Message Segments",-1)),t("div",Be,[(a(!0),i(M,null,D(e.parsedMessage,(n,p)=>(a(),i("div",{key:p,class:"mb-6"},[(a(!0),i(M,null,D(n,(f,g)=>(a(),i("div",{key:`${p}-${g}`,class:"mb-3"},[t("div",Ie,c(p)+":",1),f.fields?(a(),i("div",Ue,[(a(!0),i(M,null,D(e.renderSegmentFields(f,p,g),(u,x)=>(a(),i(M,{key:`fld-${p}-${g}-${x}`},[u.type==="separator"?(a(),i("span",He,c(u.content),1)):u.type==="button"&&u.path?(a(),i("button",{key:1,type:"button",onClick:W(m=>e.handleFieldClick(u.path),["stop"]),onMouseenter:s[2]||(s[2]=m=>e.handleButtonHover(m,!0)),onMouseleave:s[3]||(s[3]=m=>e.handleButtonHover(m,!1)),class:"inline px-1.5 py-0.5 rounded cursor-pointer transition-all duration-200 font-mono text-sm",style:{"background-color":"rgba(253, 224, 71, 0)",border:"1px solid rgba(209, 213, 219, 0.5)"}},c(u.content),41,Ve)):(a(),i("span",ze,c(u.content),1))],64))),128))])):(a(),i("div",Je,[t("button",{onClick:u=>e.handleFieldClick(`${p}[${g}].raw`),class:"hover:bg-yellow-200 px-1 rounded transition-colors"},' "'+c(f.raw)+'" ',9,Te)]))]))),128))]))),128)),s[13]||(s[13]=t("div",{class:"p-2 bg-gray-100 rounded text-xs text-gray-600 mt-2"}," ðŸ’¡ Click on any field to map it to a target variable ",-1))])]),t("div",qe,[s[15]||(s[15]=t("h4",{class:"text-md font-semibold mb-3 sticky top-0 bg-white pb-2 border-b"},"Field Mappings",-1)),t("div",Ke,[(a(),i(M,null,D(e.targetFields,n=>t("div",{key:n.key,class:Q(["border-2 rounded-lg p-3",n.color])},[t("h5",We,c(n.label),1),e.mappings[n.key].length===0?(a(),i("div",Qe," No mappings. Click a field in the segments. ")):(a(),i("div",Ge,[(a(!0),i(M,null,D(e.mappings[n.key],(p,f)=>(a(),i("div",{key:f,class:"flex items-center justify-between bg-white rounded p-2 text-xs"},[t("code",Xe,c(p),1),t("button",{onClick:g=>e.removeMapping(n.key,f),class:"p-1 hover:bg-red-100 rounded ml-2 text-red-600",title:"Remove mapping"}," âœ• ",8,Ye)]))),128))]))],2)),64))])]),t("div",Ze,[t("div",$e,[t("div",et,[s[16]||(s[16]=t("h5",{class:"text-sm font-semibold text-gray-700"},"Driver Configuration:",-1)),Object.keys(e.driverMapping).length>0?(a(),i("button",{key:0,onClick:e.downloadMappingConfig,class:"px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition",title:"Download driver configuration"}," Download ")):_("",!0)]),t("pre",tt,c(JSON.stringify(e.driverMapping,null,2)),1)]),t("div",ot,[t("div",st,[s[17]||(s[17]=t("h5",{class:"text-sm font-semibold text-gray-700"},"Extracted Data:",-1)),e.extractedData?(a(),i("button",{key:0,onClick:e.downloadExtractedData,class:"px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition",title:"Download extracted data"}," Download ")):_("",!0)]),e.extractedData?(a(),i("pre",nt,"                "+c(JSON.stringify(e.extractedData,null,2))+`
              `,1)):(a(),i("p",rt,'Click "Extract Data" to see results'))])])])):(a(),i("div",at,[...s[18]||(s[18]=[t("p",{class:"text-gray-500"},'Paste a message and click "Parse Message" to begin',-1)])]))])]),footer:I(()=>[t("div",lt,[t("button",{onClick:s[4]||(s[4]=n=>e.emit("close")),class:"px-4 py-2 border border-input rounded-md hover:bg-accent hover:text-accent-foreground transition"}," Cancel "),t("button",{onClick:e.saveDriverMapping,disabled:!e.driverMapping||Object.keys(e.driverMapping).length===0,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"}," Save Driver Mapping ",8,it)])]),_:1})):_("",!0),e.showMappingModal&&e.selectedPath?(a(),i("div",{key:1,class:"fixed inset-0 bg-black50 flex items-center justify-center z-50",onClick:s[7]||(s[7]=W(n=>e.showMappingModal=!1,["self"]))},[t("div",dt,[s[20]||(s[20]=t("h3",{class:"text-xl font-bold mb-4"},"Map Field to Target Variable",-1)),t("div",ct,[s[19]||(s[19]=t("p",{class:"text-sm text-gray-600 mb-1"},"Selected Path:",-1)),t("code",ut,c(e.selectedPath),1)]),t("div",pt,[(a(),i(M,null,D(e.targetFields,n=>t("button",{key:n.key,onClick:p=>e.addMapping(n.key),class:Q(["p-3 border-2 rounded-lg text-left hover:shadow-md transition",n.color])},[t("span",bt,c(n.label),1)],10,gt)),64))]),t("button",{onClick:s[6]||(s[6]=n=>{e.showMappingModal=!1,e.selectedPath=null}),class:"w-full px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition"}," Cancel ")])])):_("",!0)],64)}const vt=be(_e,[["render",mt],["__scopeId","data-v-f3a470d0"],["__file","/home/aurthurm/Documents/Development/felicity/felicity-lims/webapp/components/IIMapper.vue"]]);export{vt as default};
