import{d as F,f as J,b5 as k,a0 as E,t as T,aq as V,h as q,_ as C,r as z,aa as K,c,o as l,A as r,F as P,a as R,J as U,K as v,P as O,L as _}from"./index-DApeomWQ.js";import{u as B}from"./user-B9RFIqrA.js";import{p as N}from"./index-BqfY99Wm.js";const{withClientQuery:G}=J(),Q=F("auditlog",{state:()=>({auditLogs:[],fetchingAudits:!1,error:null}),getters:{getAuditLogs:i=>i.auditLogs,isLoading:i=>i.fetchingAudits,hasError:i=>i.error!==null},actions:{async fetchAuditLogs(i){this.fetchingAudits=!0,this.error=null;try{const t=await G(k,i,"auditLogsFilter");t&&Array.isArray(t)?this.auditLogs=t.map(x=>{const e={...x};if(typeof e.stateAfter=="string")try{e.stateAfter=JSON.parse(e.stateAfter)}catch{}if(typeof e.stateBefore=="string")try{e.stateBefore=JSON.parse(e.stateBefore)}catch{}if(typeof e.extras=="string")try{e.extras=JSON.parse(e.extras)}catch{}return e}):this.auditLogs=[]}catch(t){this.error=t instanceof Error?t.message:"Unknown error occurred"}finally{this.fetchingAudits=!1}},resetLogs(){this.auditLogs=[],this.error=null}}}),H=E({__name:"FelAuditLog",props:{targetUid:{type:String,required:!1,default:void 0},targetType:{type:String,required:!1,default:void 0}},setup(i,{expose:t}){t();const x=i,{targetType:e,targetUid:S}=T(x),L=B(),m=Q();m.resetLogs();const{auditLogs:A,fetchingAudits:u}=V(m);L.fetchUsers({}),m.fetchAuditLogs({targetType:e?.value,targetUid:S?.value});const d=q(()=>L.getUsers);function a(g){const y=d.value?.find(b=>(b.uid||b.userUid)?.toString()===g?.toString());return y?.userName||y?.firstName||y?.lastName||""}function D(g){switch(g){case 1:return"created";case 2:return"updated";case 3:return"deleted";default:return""}}function j(g){const y=new Set;return Object.entries(g?.stateBefore||{}).forEach(([b,s])=>{Object.entries(g?.stateAfter||{}).forEach(([f,p])=>{if(b===f&&s!==p){let h=f,o=s,n=p;f==="updated_by_uid"?(h="updated_by",o=a(s),n=a(p)):f==="submitted_by_uid"?(h="submitted_by",o=a(s),n=a(p)):f==="verified_by_uid"?(h="verified_by",o=a(s),n=a(p)):f==="updated_at"?(h="updated_on",o=N(s),n=N(p)):f==="cancelled_by_uid"?(h="cancelled_by",o=a(s),n=a(p)):f==="received_by_uid"&&(h="received_by",o=a(s),n=a(p)),y.add({key:h,old:o!=null&&typeof o=="object"?JSON.stringify(o):String(o||"None"),new:n!=null&&typeof n=="object"?JSON.stringify(n):String(n||"None")})}})}),Object.entries(g?.extras||{}).forEach(([b,s])=>{s!=null&&s!==""&&y.add({key:b,raw:typeof s=="object"?JSON.stringify(s):String(s)})}),Array.from(y)}const w={props:x,targetType:e,targetUid:S,userStore:L,auditLogStore:m,auditLogs:A,fetchingAudits:u,users:d,translateUser:a,translateAction:D,changes:j,get parseDate(){return N}};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}}),I={class:"relative mt-4",role:"log","aria-label":"Audit log"},M={key:0,class:"py-4 text-center"},W={key:1,initial:{opacity:0,y:100},enter:{opacity:1,y:0,scale:1},variants:{custom:{scale:2}},delay:200,class:"list-none m-0 p-0 space-y-4"},X={class:"flex items-center mb-2"},Y={class:"ml-4 font-medium"},Z={class:"text-foreground"},$={class:"text-primary"},ee={class:"text-muted-foreground"},te={class:"ml-12 space-y-2"},se={class:"col-span-1"},re={class:"text-sm text-muted-foreground"},ae={key:0,class:"col-span-3"},ie={class:"text-xs text-muted-secondary"},oe={key:1,class:"col-span-3 flex items-center gap-2"},ne={class:"text-xs text-destructive line-through"},de={class:"text-xs text-primary"};function ce(i,t,x,e,S,L){const m=z("fel-loader"),A=K("motion");return l(),c("div",I,[t[2]||(t[2]=r("div",{class:"border-r-2 border-border border-dotted absolute h-full top-0 z-0",style:{left:"7px"},"aria-hidden":"true"},null,-1)),e.fetchingAudits?(l(),c("div",M,[R(m,{message:"Fetching audit logs ..."})])):P((l(),c("ul",W,[(l(!0),c(U,null,v(e.auditLogs,u=>(l(),c("li",{key:u.uid,class:"relative"},[r("div",X,[t[0]||(t[0]=r("div",{class:"bg-accent rounded-full h-4 w-4 border-border border-2 z-10","aria-hidden":"true"},null,-1)),r("div",Y,[r("span",Z,[O(_(e.translateUser(u?.userUid))+" ",1),r("span",$,_(e.translateAction(u?.action)),1),O(" "+_(u?.targetType),1)]),r("span",ee," on "+_(e.parseDate(u?.stateAfter?.updated_at)),1)])]),r("div",te,[(l(!0),c(U,null,v(e.changes(u),d=>(l(),c("div",{key:d.key,class:"grid grid-cols-4 gap-2 items-center"},[r("span",se,[r("span",re,_(d?.key),1)]),d?.raw?(l(),c("span",ae,[r("span",ie,_(d?.raw),1)])):(l(),c("span",oe,[r("span",ne,_(d?.old),1),t[1]||(t[1]=r("span",{class:"text-xs text-muted-foreground","aria-hidden":"true"},"â†’",-1)),r("span",de,_(d?.new),1)]))]))),128))])]))),128))])),[[A]])])}const pe=C(H,[["render",ce],["__file","/home/administrator/Documents/Development/beak-insights/felicity/felicity-lims/webapp/components/audit/FelAuditLog.vue"]]);export{pe as default};
