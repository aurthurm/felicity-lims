import{k as G,a0 as ue,f as pe,a7 as h,h as q,a5 as ge,_ as be,r as me,c as i,o as a,C as fe,E as _,N as I,A as t,F as ve,a2 as ye,L as c,P as K,J as M,K as D,D as W,Q}from"./index-B3ZheI5m.js";const he=G`
    mutation ParseAnalyserMessage($message: String!) {
  parseAnalyserMessage(message: $message) {
    ... on AnalyzerParsedMessageType {
      __typename
      message
      seperators
    }
    ... on OperationError {
      __typename
      error
      suggestion
    }
  }
}
    `,xe=G`
    mutation ExtractAnalyserMessage($message: String!, $driver: JSONScalar!) {
  extractAnalyserMessage(message: $message, driver: $driver) {
    ... on AnalyzerExtractedMessageType {
      __typename
      message
    }
    ... on OperationError {
      __typename
      error
      suggestion
    }
  }
}
    `,_e=ue({__name:"IIMapper",props:{isOpen:{type:Boolean,required:!0},instrumentInterface:{type:null,required:!0}},emits:["close","save"],setup(J,{expose:o,emit:P}){o();const e=J,F=P,{withClientMutation:j}=pe(),b=h(null),n=h(null),p=h(""),f=h(!1),g=h(""),u=h({result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]}),x=h(null),m=h(null),A=h(!1),X=[{key:"result",label:"Result",color:"bg-info/15 border-info/40"},{key:"keyword",label:"Keyword",color:"bg-destructive/10 border-destructive/30"},{key:"reference_range",label:"Reference Range",color:"bg-success/15 border-success/40"},{key:"result_date",label:"Result Date",color:"bg-accent/15 border-accent/40"},{key:"units",label:"Units",color:"bg-warning/15 border-warning/40"},{key:"sample_id",label:"Sample ID",color:"bg-primary/10 border-primary/30"},{key:"instrument",label:"Instrument",color:"bg-secondary border-border"},{key:"result_status",label:"Result Status (F=Final, P=Preliminary)",color:"bg-warning/15 border-warning/40"}],N=q(()=>{const s={};for(const[r,d]of Object.entries(u.value)){if(d.length===0)continue;const l=d[0],v=T(l);v&&(s[r]=v)}return s}),Y=h(!1),Z=q(()=>{if(!b.value)return null;const s=Object.keys(b.value)[0];if(!s)return null;const r=b.value[s]?.[0];return{segmentKey:s,segment:r,fieldsKeys:r?.fields?Object.keys(r.fields):[],sampleStructure:r?.fields?.["0"]?JSON.stringify(r.fields[0],null,2):"Field 0 not found"}});function T(s){const r={segment:void 0,field:void 0,component:void 0,subcomponent:void 0},d=s.match(/^(\w+)\[(\d+)\]/);if(!d)return null;r.segment=d[1];const l=s.match(/\.fields\.(\d+)/);l&&(r.field=parseInt(l[1]));const v=s.match(/\.components\.(\d+)/);v&&(r.component=parseInt(v[1]));const O=s.match(/\.subcomponents\.(\d+)/);return O&&(r.subcomponent=parseInt(O[1])),Object.keys(r).forEach(k=>{r[k]===void 0&&delete r[k]}),r}async function $(){if(!p.value.trim()){g.value="Please paste a message first";return}f.value=!0,g.value="";try{j(he,{message:p.value},"parseAnalyserMessage").then(s=>{s&&s.message?(n.value=s.seperators,b.value=s.message,u.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},x.value=null):(g.value="Failed to parse message",b.value=null,n.value=null)})}catch{g.value="Failed to parse message",b.value=null,n.value=null}finally{f.value=!1}}function ee(s,r,d){const l=[];return(s.raw||"").split(n.value?.field).forEach((k,y)=>{const V=s.fields?.[String(y)];if(y>0&&l.push({type:"separator",content:n.value?.field}),V?.repeats){const L=k.split(n.value?.repeat),C=V.repeats;L.forEach((S,w)=>{w>0&&l.push({type:"separator",content:n.value?.repeat});const E=`${r}[${d}].fields.${y}.repeats[${w}].raw`;w<C.length&&C[w]?.components?S.split(n.value?.component).forEach((B,z)=>{z>0&&l.push({type:"separator",content:n.value?.component});const ce=`${r}[${d}].fields.${y}.repeats[${w}].components.${z+1}.raw`;l.push({type:"button",content:B,path:ce})}):l.push({type:"button",content:S,path:E})})}else{const L=k.split(n.value?.component);if(L.length>1)L.forEach((C,S)=>{S>0&&l.push({type:"separator",content:n.value?.component});const w=C.split(n.value?.subcomponent);if(w.length>1)w.forEach((E,R)=>{R>0&&l.push({type:"separator",content:n.value?.subcomponent});const B=`${r}[${d}].fields.${y}.components.${S+1}.subcomponents.${R+1}`;l.push({type:"button",content:E,path:B})});else{const E=`${r}[${d}].fields.${y}.components.${S+1}`;l.push({type:"button",content:C,path:E})}});else{const C=y===0?`${r}[${d}]`:`${r}[${d}].fields.${y}`;l.push({type:"button",content:k,path:C})}}}),l}function te(s){m.value=s,A.value=!0}function oe(s,r){const d=s.currentTarget;d&&(r?(d.style.backgroundColor="rgba(253, 224, 71, 1)",d.style.borderColor="rgb(234, 179, 8)",d.style.fontWeight="500"):(d.style.backgroundColor="rgba(253, 224, 71, 0)",d.style.borderColor="rgba(209, 213, 219, 0.5)",d.style.fontWeight="400"))}function se(s){m.value&&(u.value[s]=[...u.value[s],m.value],A.value=!1,m.value=null)}function ne(s,r){u.value[s]=u.value[s].filter((d,l)=>l!==r)}function re(s,r){const d=r.split(".");let l=s;for(const v of d){if(l==null)return null;if(v.includes("[")){const[O,k]=v.split("["),y=parseInt(k.replace("]",""));l=l[O]?.[y]}else l=l[v]}return l}function ae(){if(!b.value){g.value="Please parse a message first.";return}j(xe,{message:p.value,driver:JSON.stringify(N.value)},"extractAnalyserMessage").then(s=>{s&&s.message?(x.value=s.message,g.value=""):(g.value="Failed to extract data",x.value=null)})}function le(){const s={driver:N.value,timestamp:new Date().toISOString()},r=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),d=URL.createObjectURL(r),l=document.createElement("a");l.href=d,l.download="driver-mapping.json",l.click()}function ie(){if(!x.value)return;const s=new Blob([JSON.stringify(x.value,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),d=document.createElement("a");d.href=r,d.download="extracted-data.json",d.click()}function U(){p.value="",b.value=null,x.value=null,g.value="",u.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},m.value=null,A.value=!1}function de(){F("save",N.value),F("close")}ge(()=>e.isOpen,s=>{s||U()});const H={props:e,emit:F,withClientMutation:j,parsedMessage:b,parsedSeparators:n,rawInput:p,isLoading:f,parseError:g,mappings:u,extractedData:x,selectedPath:m,showMappingModal:A,targetFields:X,driverMapping:N,showDebugInfo:Y,debugInfo:Z,parsePathToConfig:T,handleParse:$,renderSegmentFields:ee,handleFieldClick:te,handleButtonHover:oe,addMapping:se,removeMapping:ne,extractValues:re,applyMappings:ae,downloadMappingConfig:le,downloadExtractedData:ie,clearAll:U,saveDriverMapping:de};return Object.defineProperty(H,"__isScriptSetup",{enumerable:!1,value:!0}),H}}),ke={class:"text-lg font-semibold text-foreground"},we={class:"space-y-4"},Me={class:""},Ce={class:"flex gap-2 mt-2"},Se=["disabled"],De={key:0,class:"mt-2 p-3 bg-destructive/10 border border-destructive/30 rounded text-destructive text-sm"},Oe={class:"flex gap-2"},Ee={key:0,class:"bg-muted border border-border rounded p-3 text-xs font-mono"},Pe={class:"mb-2"},Fe={class:"mb-2"},je={class:"mb-2"},Ae={class:"bg-card border border-border p-2 rounded mt-1 overflow-auto max-h-40"},Ne={class:"bg-card border border-border p-2 rounded mt-1 overflow-auto max-h-64"},Le={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},Re={class:"col-span-1 bg-card border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Be={class:"space-y-3 font-mono text-xs"},Ie={class:"font-bold text-info mb-2"},Je={key:0,class:"ml-4"},Te=["onClick"],Ue={key:1,class:"ml-4 mt-2 font-mono text-sm break-all"},He={key:0,class:"text-muted-foreground select-none"},Ve=["onClick"],ze={key:2},qe={class:"col-span-1 bg-card border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Ke={class:"space-y-3"},We={class:"font-semibold mb-2"},Qe={key:0,class:"text-xs text-muted-foreground italic"},Ge={key:1,class:"space-y-1"},Xe={class:"font-mono text-foreground truncate flex-1"},Ye=["onClick"],Ze={class:"col-span-1 bg-card border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},$e={class:"mb-4"},et={class:"flex items-center justify-between mb-2"},tt={class:"bg-muted/60 border border-border p-2 rounded text-xs overflow-auto max-h-[250px]"},ot={class:"mb-4"},st={class:"flex items-center justify-between mb-2"},nt={key:0,class:"bg-muted/60 border border-border p-2 rounded text-xs overflow-auto max-h-[200px]"},rt={key:1,class:"text-xs text-muted-foreground italic"},at={key:2,class:"text-center py-12 bg-muted/60 rounded-lg border border-border"},lt={class:"flex justify-end gap-2"},it=["disabled"],dt={class:"bg-card rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4"},ct={class:"mb-4 p-3 bg-muted rounded"},ut={class:"text-sm font-mono text-info break-all"},pt={class:"grid grid-cols-2 gap-3 mb-4 max-h-[400px] overflow-auto"},gt=["onClick"],bt={class:"font-semibold"};function mt(J,o,P,e,F,j){const b=me("beak-modal");return a(),i(M,null,[P.isOpen?(a(),fe(b,{key:0,onClose:o[5]||(o[5]=n=>e.emit("close")),contentWidth:"w-full max-w-7xl"},{header:I(()=>[t("h3",ke," Driver Mapper - "+c(P.instrumentInterface?.laboratoryInstrument?.labName||"Instrument"),1)]),body:I(()=>[t("div",we,[t("div",Me,[o[8]||(o[8]=t("h4",{class:"text-base font-semibold text-foreground mb-3"},"Paste ASTM/HL7 Message",-1)),ve(t("textarea",{"onUpdate:modelValue":o[0]||(o[0]=n=>e.rawInput=n),placeholder:"Paste your raw ASTM/HL7 message here",class:"w-full h-32 p-3 border border-input rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[ye,e.rawInput]]),t("div",Ce,[t("button",{onClick:e.handleParse,disabled:e.isLoading,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"},c(e.isLoading?"Parsing...":"Parse Message"),9,Se),e.parsedMessage?(a(),i("button",{key:0,onClick:e.applyMappings,class:"px-4 py-2 bg-success text-primary-foreground rounded-md hover:bg-success/90 transition"}," Extract Data ")):_("",!0),e.parsedMessage&&Object.values(e.mappings).some(n=>n.length>0)?(a(),i("button",{key:1,onClick:e.downloadMappingConfig,class:"px-4 py-2 bg-secondary text-primary-foreground rounded-md hover:bg-secondary/80 transition"}," Save Mappings ")):_("",!0),e.parsedMessage?(a(),i("button",{key:2,onClick:e.clearAll,class:"px-4 py-2 bg-destructive text-primary-foreground rounded-md hover:bg-destructive/90 transition"}," Clear ")):_("",!0)]),e.parseError?(a(),i("div",De," âš ï¸ "+c(e.parseError),1)):_("",!0)]),t("div",Oe,[t("button",{onClick:o[1]||(o[1]=n=>e.showDebugInfo=!e.showDebugInfo),class:"px-3 py-1 text-xs bg-muted-foreground text-primary-foreground rounded hover:bg-muted/80 transition"},c(e.showDebugInfo?"Hide":"Show")+" Debug Info ",1)]),e.showDebugInfo&&e.debugInfo?(a(),i("div",Ee,[t("div",Pe,[o[9]||(o[9]=t("strong",null,"First Segment:",-1)),K(" "+c(e.debugInfo.segmentKey),1)]),t("div",Fe,[o[10]||(o[10]=t("strong",null,"Field Keys:",-1)),K(" "+c(e.debugInfo.fieldsKeys.join(", ")),1)]),t("div",je,[o[11]||(o[11]=t("strong",null,"Sample Field Structure (Field 0):",-1)),t("pre",Ae,c(e.debugInfo.sampleStructure),1)]),t("div",null,[o[12]||(o[12]=t("strong",null,"Full Parsed Message:",-1)),t("pre",Ne,c(JSON.stringify(e.parsedMessage,null,2)),1)])])):_("",!0),e.parsedMessage?(a(),i("div",Le,[t("div",Re,[o[14]||(o[14]=t("h4",{class:"text-base font-semibold mb-3 sticky top-0 bg-card pb-2 border-b"},"Parsed Message Segments",-1)),t("div",Be,[(a(!0),i(M,null,D(e.parsedMessage,(n,p)=>(a(),i("div",{key:p,class:"mb-6"},[(a(!0),i(M,null,D(n,(f,g)=>(a(),i("div",{key:`${p}-${g}`,class:"mb-3"},[t("div",Ie,c(p)+":",1),f.fields?(a(),i("div",Ue,[(a(!0),i(M,null,D(e.renderSegmentFields(f,p,g),(u,x)=>(a(),i(M,{key:`fld-${p}-${g}-${x}`},[u.type==="separator"?(a(),i("span",He,c(u.content),1)):u.type==="button"&&u.path?(a(),i("button",{key:1,type:"button",onClick:W(m=>e.handleFieldClick(u.path),["stop"]),onMouseenter:o[2]||(o[2]=m=>e.handleButtonHover(m,!0)),onMouseleave:o[3]||(o[3]=m=>e.handleButtonHover(m,!1)),class:"inline px-1.5 py-0.5 rounded cursor-pointer transition-all duration-200 font-mono text-sm",style:{"background-color":"rgba(253, 224, 71, 0)",border:"1px solid rgba(209, 213, 219, 0.5)"}},c(u.content),41,Ve)):(a(),i("span",ze,c(u.content),1))],64))),128))])):(a(),i("div",Je,[t("button",{onClick:u=>e.handleFieldClick(`${p}[${g}].raw`),class:"hover:bg-warning/25 px-1 rounded transition-colors"},' "'+c(f.raw)+'" ',9,Te)]))]))),128))]))),128)),o[13]||(o[13]=t("div",{class:"p-2 bg-muted rounded text-xs text-muted-foreground mt-2"}," ðŸ’¡ Click on any field to map it to a target variable ",-1))])]),t("div",qe,[o[15]||(o[15]=t("h4",{class:"text-base font-semibold mb-3 sticky top-0 bg-card pb-2 border-b"},"Field Mappings",-1)),t("div",Ke,[(a(),i(M,null,D(e.targetFields,n=>t("div",{key:n.key,class:Q(["border-2 rounded-lg p-3",n.color])},[t("h5",We,c(n.label),1),e.mappings[n.key].length===0?(a(),i("div",Qe," No mappings. Click a field in the segments. ")):(a(),i("div",Ge,[(a(!0),i(M,null,D(e.mappings[n.key],(p,f)=>(a(),i("div",{key:f,class:"flex items-center justify-between bg-card rounded p-2 text-xs"},[t("code",Xe,c(p),1),t("button",{onClick:g=>e.removeMapping(n.key,f),class:"p-1 hover:bg-destructive/10 rounded ml-2 text-destructive",title:"Remove mapping"}," âœ• ",8,Ye)]))),128))]))],2)),64))])]),t("div",Ze,[t("div",$e,[t("div",et,[o[16]||(o[16]=t("h5",{class:"text-sm font-semibold text-foreground"},"Driver Configuration:",-1)),Object.keys(e.driverMapping).length>0?(a(),i("button",{key:0,onClick:e.downloadMappingConfig,class:"px-2 py-1 bg-info text-primary-foreground text-xs rounded hover:bg-info/90 transition",title:"Download driver configuration"}," Download ")):_("",!0)]),t("pre",tt,c(JSON.stringify(e.driverMapping,null,2)),1)]),t("div",ot,[t("div",st,[o[17]||(o[17]=t("h5",{class:"text-sm font-semibold text-foreground"},"Extracted Data:",-1)),e.extractedData?(a(),i("button",{key:0,onClick:e.downloadExtractedData,class:"px-2 py-1 bg-success text-primary-foreground text-xs rounded hover:bg-success/90 transition",title:"Download extracted data"}," Download ")):_("",!0)]),e.extractedData?(a(),i("pre",nt,"                "+c(JSON.stringify(e.extractedData,null,2))+`
              `,1)):(a(),i("p",rt,'Click "Extract Data" to see results'))])])])):(a(),i("div",at,[...o[18]||(o[18]=[t("p",{class:"text-muted-foreground"},'Paste a message and click "Parse Message" to begin',-1)])]))])]),footer:I(()=>[t("div",lt,[t("button",{onClick:o[4]||(o[4]=n=>e.emit("close")),class:"px-4 py-2 border border-input rounded-md hover:bg-accent hover:text-accent-foreground transition"}," Cancel "),t("button",{onClick:e.saveDriverMapping,disabled:!e.driverMapping||Object.keys(e.driverMapping).length===0,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"}," Save Driver Mapping ",8,it)])]),_:1})):_("",!0),e.showMappingModal&&e.selectedPath?(a(),i("div",{key:1,class:"fixed inset-0 bg-black50 flex items-center justify-center z-50",onClick:o[7]||(o[7]=W(n=>e.showMappingModal=!1,["self"]))},[t("div",dt,[o[20]||(o[20]=t("h3",{class:"text-xl font-bold mb-4"},"Map Field to Target Variable",-1)),t("div",ct,[o[19]||(o[19]=t("p",{class:"text-sm text-muted-foreground mb-1"},"Selected Path:",-1)),t("code",ut,c(e.selectedPath),1)]),t("div",pt,[(a(),i(M,null,D(e.targetFields,n=>t("button",{key:n.key,onClick:p=>e.addMapping(n.key),class:Q(["p-3 border-2 rounded-lg text-left hover:shadow-md transition",n.color])},[t("span",bt,c(n.label),1)],10,gt)),64))]),t("button",{onClick:o[6]||(o[6]=n=>{e.showMappingModal=!1,e.selectedPath=null}),class:"w-full px-4 py-2 bg-muted text-foreground rounded hover:bg-muted-foreground transition"}," Cancel ")])])):_("",!0)],64)}const vt=be(_e,[["render",mt],["__scopeId","data-v-f3a470d0"],["__file","/home/administrator/Documents/Development/beak-insights/felicity/felicity-lims/webapp/components/IIMapper.vue"]]);export{vt as default};
