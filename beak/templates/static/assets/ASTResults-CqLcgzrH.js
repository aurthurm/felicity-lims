import{a0 as de,u as ue,f as ce,h as me,a7 as g,ad as fe,a5 as be,aQ as ge,U as ve,_ as pe,r as B,c,o as u,A as o,E as A,C as ye,J as v,K as y,F as p,L as h,H as T,a9 as G,a2 as J,Q as K,a as M,a3 as he,N as P,P as j,D as F}from"./index-DCVfsbos.js";import{u as xe}from"./analysis-CsALefh6.js";import{s as _e}from"./index-BaPnjn4Y.js";import{G as Re,b as Ae,c as Ue,d as Ce,e as we,f as Se,U as Te}from"./microbiology.mutations-CV_wjL4A.js";import"./analyses.mutations-BEU63HnJ.js";const Pe=de({__name:"ASTResults",props:{sample:{type:Object,required:!0},organismAnalysisResults:{type:Object,required:!0}},setup(b,{expose:d}){d();const U=ue(),{withClientMutation:e,withClientQuery:_}=ce(),E=me(()=>b.organismAnalysisResults[0]),R=g([]),x=g([]),V=g([]),t=g([]);fe(()=>{_(Re,{analysisResultUid:E.value.uid},"abxOrganismResultAll").then(s=>{s&&(x.value=s||[])}).finally(()=>S()),w(),_(Ae,{},"abxGuidelineYearAll").then(s=>{s&&(V.value=s||[])}),_(Ue,{},"abxTestMethodAll").then(s=>{s&&(t.value=s||[])})});const n=g(!1),r=g(!1),N=g(""),I=g([]),C=g();function w(){_(Ce,{sampleUid:b.sample.uid},"abxAstResultAll").then(s=>{s&&(R.value=s||[])}).finally(()=>S())}function W(s){C.value=s,n.value=!0}function X(s){const a=f.value[s.uid];return a?Object.values(a)?.every(m=>m.status=="pending"):!1}function Z(){r.value=!0,_(we,{organismUid:C.value?.uid,text:N.value},"abxAstPanelFilter").then(s=>{s&&(I.value=s||[])}).finally(()=>{r.value=!1})}function O(s){n.value=!1,ge.fire({title:"Are you sure?",text:"You want to apply panel: "+s.name+" to organism: "+C.value?.organism?.name,icon:"warning",showCancelButton:!0,confirmButtonColor:"hsl(var(--primary))",cancelButtonColor:"hsl(var(--destructive))",confirmButtonText:"Yes, apply now!",cancelButtonText:"No, do not apply!"}).then(async a=>{a.isConfirmed&&e(Se,{payload:{organismResultUid:C.value?.uid,panelUid:s.uid,sampleUid:b.sample.uid}},"applyAbxAstPanel").then(m=>{m?.astResults?.forEach(l=>R.value.push(l)),S()})})}const f=g({});function S(){const s={};x.value?.forEach(a=>{s[a.uid]={},(R.value?.filter(l=>l.organismResultUid===a.uid)).forEach(l=>{l.antibiotic?.name&&(s[a.uid][l.antibiotic.name+" "+l.antibiotic.potency]={uid:l.uid,analResultUid:l.analysisResultUid,status:l.analysisResult?.status,astMethodUid:l.astMethodUid??"",guidelineYearUid:l.guidelineYearUid??"",breakpointUid:l.breakpointUid??"",astValue:l.astValue??"",result:l.analysisResult?.result??"",reportable:l.analysisResult?.reportable??!1,dirty:!1})})}),f.value=s}be([x,R],()=>{S()});const $=s=>Object.keys(f.value[s]||{});let{submitResults:D,approveResults:k}=xe();function ee(s){const a=f.value[s];if(!a)return!1;const m=Object.values(a)?.some(i=>i.dirty&&i.status=="pending"),l=Object.values(a)?.some(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue);return m&&l}function L(s){const a=f.value[s];return(Object.values(a)?.filter(i=>i.dirty&&i.status=="pending")).filter(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue).map(({dirty:i,breakpointUid:ie,analResultUid:H,status:bt,...re})=>re)}const Y=g(!1);function te(s){Y.value=!0;const a=L(s);e(Te,{payload:{results:a}},"updateAbxAstResults").then(()=>{U.fetchAnalysisResultsForSample(b.sample.uid),w()}).finally(()=>Y.value=!1)}function se(s){const a=f.value[s];if(!a)return!1;const m=Object.values(a)?.some(i=>i.dirty),l=Object.values(a)?.some(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue&&i.result&&i.status=="pending");return!m&&l&&b.sample.status!="submitting"}function Q(s){const a=f.value[s];return(Object.values(a)?.filter(i=>!i.dirty)).filter(i=>i.guidelineYearUid&&i.astMethodUid&&i.astValue&&i.result&&i.status=="pending").map(({dirty:i,breakpointUid:ie,...H})=>H)}function oe(s){const m=Q(s).map(l=>({uid:l.analResultUid,result:l.result??"",reportable:l.reportable??!1,methodUid:"beak_ast",laboratoryInstrumentUid:"beak_ast"}));D(m,ve.Sample,b.sample?.uid).then(()=>{U.fetchAnalysisResultsForSample(b.sample.uid),w()})}function ne(s){const a=f.value[s];if(!a)return!1;const m=Object.values(a)?.some(i=>i.dirty),l=Object.values(a)?.some(i=>i.status=="resulted");return!m&&l&&b.sample.status!="approving"}function q(s){const a=f.value[s];return(Object.values(a)?.filter(l=>!l.dirty)).filter(l=>l.status=="resulted")}function le(s){const m=q(s).map(l=>l.analResultUid);k(m,"sample",b.sample?.uid).then(()=>{U.fetchAnalysisResultsForSample(b.sample.uid),w()})}async function ae(s,a,m,l){f.value[s][a],f.value[s][a].dirty=!0,f.value[s][a]={...f.value[s][a],[m]:l}}const z={sampleStore:U,withClientMutation:e,withClientQuery:_,organismResult:E,astResults:R,pickedOrganisms:x,guidelines:V,testMethods:t,showModal:n,loadingPanels:r,searchPanelText:N,panels:I,choiceOrganism:C,fetchAstResultAll:w,choosePanel:W,canAddPanel:X,searchPanels:Z,applyPanel:O,organismResults:f,processASTResults:S,getAntibiotics:$,get submitter_(){return D},set submitter_(s){D=s},get approver_(){return k},set approver_(s){k=s},canSave:ee,getSavable:L,savingAntibiotics:Y,saveAntibiotics:te,canSubmit:se,getSubmittable:Q,submitAntibiotics:oe,canApprove:ne,getApprovable:q,approveAntibiotics:le,handleCellEdit:ae,get shield(){return _e}};return Object.defineProperty(z,"__isScriptSetup",{enumerable:!1,value:!0}),z}}),Ve={class:"space-y-6"},Me={class:"space-y-8"},je={class:"flex items-center justify-between"},Ee={class:"space-x-2"},De={class:"font-semibold text-foreground"},ke={class:"text-muted-foreground"},Ye=["onClick"],Be={class:"rounded-lg border border-border bg-background"},Ge={class:"overflow-x-auto"},Fe={class:"w-full beak-table"},Ne={class:"border-b border-border bg-muted/50"},Ie={class:"border-b border-border"},Le=["onUpdate:modelValue","onChange","disabled"],Qe=["value"],qe={class:"border-b border-border"},ze=["onUpdate:modelValue","onChange","disabled"],He=["value"],Je={class:"border-b border-border"},Ke=["onUpdate:modelValue","onChange","disabled"],We={class:"border-b border-border"},Xe={class:"flex items-center space-x-2"},Ze=["onUpdate:modelValue","onChange","disabled"],Oe={class:"flex items-center space-x-4"},$e=["onUpdate:modelValue","onChange","disabled"],et={class:"flex items-center space-x-4"},tt={class:"text-lg font-semibold text-foreground"},st={class:"italic"},ot={class:"space-y-6"},nt={class:"space-y-4"},lt={class:"rounded-lg border border-border"},at={class:"overflow-y-auto max-h-64"},it={class:"w-full beak-table"},rt={class:"px-4 py-3"},dt={class:"font-medium text-foreground"},ut={class:"text-sm text-muted-foreground"},ct={class:"px-4 py-3 text-right"},mt=["onClick"];function ft(b,d,U,e,_,E){const R=B("font-awesome-icon"),x=B("beak-button"),V=B("beak-modal");return u(),c(v,null,[o("div",Ve,[d[12]||(d[12]=o("div",{class:"flex items-center justify-between border-b border-border pb-4"},[o("h3",{class:"text-lg font-semibold text-foreground"},"AST Panel")],-1)),o("div",Me,[(u(!0),c(v,null,y(e.pickedOrganisms,t=>(u(),c("div",{key:t.uid,class:"space-y-6"},[o("div",je,[o("div",Ee,[o("span",De,"Organism #"+h(t?.isolateNumber),1),o("span",ke,h(t?.organism?.name),1)]),p(o("button",{onClick:n=>e.choosePanel(t),class:"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"}," Choose Panel ",8,Ye),[[T,e.canAddPanel(t)]])]),o("div",Be,[o("div",Ge,[o("table",Fe,[o("thead",null,[o("tr",Ne,[d[2]||(d[2]=o("th",{class:"px-4 py-3 text-left text-sm font-medium text-muted-foreground"},"Parameter",-1)),(u(!0),c(v,null,y(e.getAntibiotics(t.uid),n=>(u(),c("th",{key:n,class:"px-4 py-3 text-left text-sm font-medium text-muted-foreground"},h(n),1))),128))])]),o("tbody",null,[A(" Guideline year "),o("tr",Ie,[d[3]||(d[3]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"Guideline",-1)),(u(!0),c(v,null,y(e.getAntibiotics(t.uid),n=>(u(),c("td",{key:n,class:"px-4 py-3"},[p(o("select",{"onUpdate:modelValue":r=>e.organismResults[t.uid][n].guidelineYearUid=r,onChange:r=>e.handleCellEdit(t.uid,n,"guidelineYearUid",r.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[t.uid][n].status!=="pending"},[(u(!0),c(v,null,y(e.guidelines,r=>(u(),c("option",{key:r.uid,value:r.uid},h(r.code),9,Qe))),128))],40,Le),[[G,e.organismResults[t.uid][n].guidelineYearUid]])]))),128))]),A(" AST Method "),o("tr",qe,[d[4]||(d[4]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"AST Method",-1)),(u(!0),c(v,null,y(e.getAntibiotics(t.uid),n=>(u(),c("td",{key:n,class:"px-4 py-3"},[p(o("select",{"onUpdate:modelValue":r=>e.organismResults[t.uid][n].astMethodUid=r,onChange:r=>e.handleCellEdit(t.uid,n,"astMethodUid",r.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[t.uid][n].status!=="pending"},[(u(!0),c(v,null,y(e.testMethods,r=>(u(),c("option",{key:r.uid,value:r.uid},h(r.name),9,He))),128))],40,ze),[[G,e.organismResults[t.uid][n].astMethodUid]])]))),128))]),A(" AST Value "),o("tr",Je,[d[5]||(d[5]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"AST Value",-1)),(u(!0),c(v,null,y(e.getAntibiotics(t.uid),n=>(u(),c("td",{key:n,class:"px-4 py-3"},[p(o("input",{type:"number","onUpdate:modelValue":r=>e.organismResults[t.uid][n].astValue=r,onChange:r=>e.handleCellEdit(t.uid,n,"astValue",r.target.value),class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",step:"0.1",disabled:e.organismResults[t.uid][n].status!=="pending"},null,40,Ke),[[J,e.organismResults[t.uid][n].astValue]])]))),128))]),A(" Result "),o("tr",We,[d[7]||(d[7]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"Result",-1)),(u(!0),c(v,null,y(e.getAntibiotics(t.uid),n=>(u(),c("td",{key:n,class:"px-4 py-3"},[o("div",Xe,[p(o("select",{"onUpdate:modelValue":r=>e.organismResults[t.uid][n].result=r,onChange:r=>e.handleCellEdit(t.uid,n,"result",r.target.value),class:K(["w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",{"text-success":e.organismResults[t.uid][n].result?.toUpperCase()==="S","text-warning":e.organismResults[t.uid][n].result?.toUpperCase()==="I","text-destructive":e.organismResults[t.uid][n].result?.toUpperCase()==="R"}]),disabled:e.organismResults[t.uid][n].status!=="pending"},[...d[6]||(d[6]=[o("option",{value:"S"},"S",-1),o("option",{value:"I"},"I",-1),o("option",{value:"R"},"R",-1)])],42,Ze),[[G,e.organismResults[t.uid][n].result]]),p(o("span",null,[M(R,{icon:"robot",class:"text-muted-foreground","aria-label":"Auto-calculated"})],512),[[T,e.organismResults[t.uid][n].breakpointUid]])])]))),128))]),A(" Reportable "),o("tr",null,[d[8]||(d[8]=o("td",{class:"px-4 py-3 text-sm font-medium text-foreground"},"Reportable",-1)),(u(!0),c(v,null,y(e.getAntibiotics(t.uid),n=>(u(),c("td",{key:n,class:"px-4 py-3"},[o("div",Oe,[p(o("input",{type:"checkbox","onUpdate:modelValue":r=>e.organismResults[t.uid][n].reportable=r,onChange:r=>e.handleCellEdit(t.uid,n,"reportable",r.target.checked),class:"rounded border-input text-primary focus:ring-primary disabled:cursor-not-allowed disabled:opacity-50",disabled:e.organismResults[t.uid][n].status!=="pending"},null,40,$e),[[he,e.organismResults[t.uid][n].reportable]]),o("span",{class:K(["inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",{"bg-primary/10 text-primary":e.organismResults[t.uid][n].status==="pending","bg-warning/10 text-warning":e.organismResults[t.uid][n].status==="resulted","bg-success/10 text-success":e.organismResults[t.uid][n].status==="approved","bg-destructive/10 text-destructive":e.organismResults[t.uid][n].status==="cancelled"}])},h(e.organismResults[t.uid][n].status),3)])]))),128))])])])])]),o("div",et,[p(M(x,{key:"save",onClick:F(n=>e.saveAntibiotics(t.uid),["prevent"]),color:"primary",disabled:e.savingAntibiotics},{default:P(()=>[...d[9]||(d[9]=[j(" Save Antibiotics ",-1)])]),_:1},8,["onClick","disabled"]),[[T,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canSave(t.uid)]]),p(M(x,{key:"submit",onClick:F(n=>e.submitAntibiotics(t.uid),["prevent"]),color:"warning"},{default:P(()=>[...d[10]||(d[10]=[j(" Submit Antibiotics ",-1)])]),_:1},8,["onClick"]),[[T,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canSubmit(t.uid)]]),p(M(x,{key:"approve",onClick:F(n=>e.approveAntibiotics(t.uid),["prevent"]),color:"success"},{default:P(()=>[...d[11]||(d[11]=[j(" Approve Antibiotics ",-1)])]),_:1},8,["onClick"]),[[T,e.shield.hasRights(e.shield.actions.UPDATE,e.shield.objects.RESULT)&&e.canApprove(t.uid)]])])]))),128))])]),A(" Panel Form Modal "),e.showModal?(u(),ye(V,{key:0,onClose:d[1]||(d[1]=t=>e.showModal=!1),contentWidth:"w-1/2"},{header:P(()=>[o("h3",tt,[d[13]||(d[13]=j(" Search Panel for ",-1)),o("span",st,h(e.choiceOrganism?.organism?.name),1)])]),body:P(()=>[o("div",ot,[o("div",nt,[p(o("input",{"onUpdate:modelValue":d[0]||(d[0]=t=>e.searchPanelText=t),onInput:e.searchPanels,class:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",placeholder:"Begin typing..."},null,544),[[J,e.searchPanelText]]),o("div",lt,[o("div",at,[o("table",it,[o("tbody",null,[(u(!0),c(v,null,y(e.panels,t=>(u(),c("tr",{key:t.uid,class:"border-b border-border hover:bg-muted/50 transition-colors duration-200"},[o("td",rt,[o("div",dt,h(t.name),1),o("div",ut,h(t.antibiotics?.map(n=>n.name)?.join(", ")),1)]),o("td",ct,[o("button",{onClick:n=>e.applyPanel(t),class:"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2"}," Apply ",8,mt)])]))),128))])])])])])])]),_:1})):A("v-if",!0)],64)}const xt=pe(Pe,[["render",ft],["__file","/home/administrator/Documents/Development/beak-insights/beak/beak-lims/webapp/views/sample/_id/results/ASTResults.vue"]]);export{xt as default};
