import{k as G,a0 as ue,f as pe,a7 as _,h as q,a5 as ge,_ as be,r as me,c as i,o as a,C as fe,E as c,N as T,A as t,F as ve,a2 as ye,L as u,P as K,J as v,K as S,D as W,Q}from"./index-DCVfsbos.js";const he=G`
    mutation ParseAnalyserMessage($message: String!) {
  parseAnalyserMessage(message: $message) {
    ... on AnalyzerParsedMessageType {
      __typename
      message
      seperators
    }
    ... on OperationError {
      __typename
      error
      suggestion
    }
  }
}
    `,xe=G`
    mutation ExtractAnalyserMessage($message: String!, $driver: JSONScalar!) {
  extractAnalyserMessage(message: $message, driver: $driver) {
    ... on AnalyzerExtractedMessageType {
      __typename
      message
    }
    ... on OperationError {
      __typename
      error
      suggestion
    }
  }
}
    `,_e=ue({__name:"IIMapper",props:{isOpen:{type:Boolean,required:!0},instrumentInterface:{type:null,required:!0}},emits:["close","save"],setup(B,{expose:o,emit:O}){o();const e=B,F=O,{withClientMutation:j}=pe(),m=_(null),n=_(null),g=_(""),y=_(!1),b=_(""),p=_({result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]}),k=_(null),f=_(null),A=_(!1),X=[{key:"result",label:"Result",color:"bg-info/15 border-info/40"},{key:"keyword",label:"Keyword",color:"bg-destructive/10 border-destructive/30"},{key:"reference_range",label:"Reference Range",color:"bg-success/15 border-success/40"},{key:"result_date",label:"Result Date",color:"bg-accent/15 border-accent/40"},{key:"units",label:"Units",color:"bg-warning/15 border-warning/40"},{key:"sample_id",label:"Sample ID",color:"bg-primary/10 border-primary/30"},{key:"instrument",label:"Instrument",color:"bg-secondary border-border"},{key:"result_status",label:"Result Status (F=Final, P=Preliminary)",color:"bg-warning/15 border-warning/40"}],N=q(()=>{const s={};for(const[r,d]of Object.entries(p.value)){if(d.length===0)continue;const l=d[0],h=J(l);h&&(s[r]=h)}return s}),Y=_(!1),Z=q(()=>{if(!m.value)return null;const s=Object.keys(m.value)[0];if(!s)return null;const r=m.value[s]?.[0];return{segmentKey:s,segment:r,fieldsKeys:r?.fields?Object.keys(r.fields):[],sampleStructure:r?.fields?.["0"]?JSON.stringify(r.fields[0],null,2):"Field 0 not found"}});function J(s){const r={segment:void 0,field:void 0,component:void 0,subcomponent:void 0},d=s.match(/^(\w+)\[(\d+)\]/);if(!d)return null;r.segment=d[1];const l=s.match(/\.fields\.(\d+)/);l&&(r.field=parseInt(l[1]));const h=s.match(/\.components\.(\d+)/);h&&(r.component=parseInt(h[1]));const E=s.match(/\.subcomponents\.(\d+)/);return E&&(r.subcomponent=parseInt(E[1])),Object.keys(r).forEach(w=>{r[w]===void 0&&delete r[w]}),r}async function $(){if(!g.value.trim()){b.value="Please paste a message first";return}y.value=!0,b.value="";try{j(he,{message:g.value},"parseAnalyserMessage").then(s=>{s&&s.message?(n.value=s.seperators,m.value=s.message,p.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},k.value=null):(b.value="Failed to parse message",m.value=null,n.value=null)})}catch{b.value="Failed to parse message",m.value=null,n.value=null}finally{y.value=!1}}function ee(s,r,d){const l=[];return(s.raw||"").split(n.value?.field).forEach((w,x)=>{const V=s.fields?.[String(x)];if(x>0&&l.push({type:"separator",content:n.value?.field}),V?.repeats){const R=w.split(n.value?.repeat),C=V.repeats;R.forEach((D,M)=>{M>0&&l.push({type:"separator",content:n.value?.repeat});const P=`${r}[${d}].fields.${x}.repeats[${M}].raw`;M<C.length&&C[M]?.components?D.split(n.value?.component).forEach((I,z)=>{z>0&&l.push({type:"separator",content:n.value?.component});const ce=`${r}[${d}].fields.${x}.repeats[${M}].components.${z+1}.raw`;l.push({type:"button",content:I,path:ce})}):l.push({type:"button",content:D,path:P})})}else{const R=w.split(n.value?.component);if(R.length>1)R.forEach((C,D)=>{D>0&&l.push({type:"separator",content:n.value?.component});const M=C.split(n.value?.subcomponent);if(M.length>1)M.forEach((P,L)=>{L>0&&l.push({type:"separator",content:n.value?.subcomponent});const I=`${r}[${d}].fields.${x}.components.${D+1}.subcomponents.${L+1}`;l.push({type:"button",content:P,path:I})});else{const P=`${r}[${d}].fields.${x}.components.${D+1}`;l.push({type:"button",content:C,path:P})}});else{const C=x===0?`${r}[${d}]`:`${r}[${d}].fields.${x}`;l.push({type:"button",content:w,path:C})}}}),l}function te(s){f.value=s,A.value=!0}function oe(s,r){const d=s.currentTarget;d&&(r?(d.style.backgroundColor="rgba(253, 224, 71, 1)",d.style.borderColor="rgb(234, 179, 8)",d.style.fontWeight="500"):(d.style.backgroundColor="rgba(253, 224, 71, 0)",d.style.borderColor="rgba(209, 213, 219, 0.5)",d.style.fontWeight="400"))}function se(s){f.value&&(p.value[s]=[...p.value[s],f.value],A.value=!1,f.value=null)}function ne(s,r){p.value[s]=p.value[s].filter((d,l)=>l!==r)}function re(s,r){const d=r.split(".");let l=s;for(const h of d){if(l==null)return null;if(h.includes("[")){const[E,w]=h.split("["),x=parseInt(w.replace("]",""));l=l[E]?.[x]}else l=l[h]}return l}function ae(){if(!m.value){b.value="Please parse a message first.";return}j(xe,{message:g.value,driver:JSON.stringify(N.value)},"extractAnalyserMessage").then(s=>{s&&s.message?(k.value=s.message,b.value=""):(b.value="Failed to extract data",k.value=null)})}function le(){const s={driver:N.value,timestamp:new Date().toISOString()},r=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),d=URL.createObjectURL(r),l=document.createElement("a");l.href=d,l.download="driver-mapping.json",l.click()}function ie(){if(!k.value)return;const s=new Blob([JSON.stringify(k.value,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),d=document.createElement("a");d.href=r,d.download="extracted-data.json",d.click()}function U(){g.value="",m.value=null,k.value=null,b.value="",p.value={result:[],keyword:[],reference_range:[],result_date:[],units:[],sample_id:[],instrument:[],result_status:[]},f.value=null,A.value=!1}function de(){F("save",N.value),F("close")}ge(()=>e.isOpen,s=>{s||U()});const H={props:e,emit:F,withClientMutation:j,parsedMessage:m,parsedSeparators:n,rawInput:g,isLoading:y,parseError:b,mappings:p,extractedData:k,selectedPath:f,showMappingModal:A,targetFields:X,driverMapping:N,showDebugInfo:Y,debugInfo:Z,parsePathToConfig:J,handleParse:$,renderSegmentFields:ee,handleFieldClick:te,handleButtonHover:oe,addMapping:se,removeMapping:ne,extractValues:re,applyMappings:ae,downloadMappingConfig:le,downloadExtractedData:ie,clearAll:U,saveDriverMapping:de};return Object.defineProperty(H,"__isScriptSetup",{enumerable:!1,value:!0}),H}}),ke={class:"text-lg font-semibold text-foreground"},we={class:"space-y-4"},Me={class:""},Ce={class:"flex gap-2 mt-2"},De=["disabled"],Se={key:0,class:"mt-2 p-3 bg-destructive/10 border border-destructive/30 rounded text-destructive text-sm"},Ee={class:"flex gap-2"},Pe={key:0,class:"bg-muted border border-border rounded p-3 text-xs font-mono"},Oe={class:"mb-2"},Fe={class:"mb-2"},je={class:"mb-2"},Ae={class:"bg-card border border-border p-2 rounded mt-1 overflow-auto max-h-40"},Ne={class:"bg-card border border-border p-2 rounded mt-1 overflow-auto max-h-64"},Re={key:1,class:"grid grid-cols-1 lg:grid-cols-3 gap-4"},Le={class:"col-span-1 bg-card border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Ie={class:"space-y-3 font-mono text-xs"},Te={class:"font-bold text-info mb-2"},Be={key:0,class:"ml-4"},Je=["onClick"],Ue={key:1,class:"ml-4 mt-2 font-mono text-sm break-all"},He={key:0,class:"text-muted-foreground select-none"},Ve=["onClick"],ze={class:"col-span-1 bg-card border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},qe={class:"space-y-3"},Ke={class:"font-semibold mb-2"},We={key:0,class:"text-xs text-muted-foreground italic"},Qe={key:1,class:"space-y-1"},Ge={class:"font-mono text-foreground truncate flex-1"},Xe=["onClick"],Ye={class:"col-span-1 bg-card border border-border rounded-lg shadow p-4 max-h-[500px] overflow-auto"},Ze={class:"mb-4"},$e={class:"flex items-center justify-between mb-2"},et={class:"bg-muted/60 border border-border p-2 rounded text-xs overflow-auto max-h-[250px]"},tt={class:"mb-4"},ot={class:"flex items-center justify-between mb-2"},st={key:0,class:"bg-muted/60 border border-border p-2 rounded text-xs overflow-auto max-h-[200px]"},nt={key:1,class:"text-xs text-muted-foreground italic"},rt={class:"flex justify-end gap-2"},at=["disabled"],lt={class:"bg-card rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4"},it={class:"mb-4 p-3 bg-muted rounded"},dt={class:"text-sm font-mono text-info break-all"},ct={class:"grid grid-cols-2 gap-3 mb-4 max-h-[400px] overflow-auto"},ut=["onClick"],pt={class:"font-semibold"};function gt(B,o,O,e,F,j){const m=me("beak-modal");return a(),i(v,null,[O.isOpen?(a(),fe(m,{key:0,onClose:o[5]||(o[5]=n=>e.emit("close")),contentWidth:"w-full max-w-7xl"},{header:T(()=>[t("h3",ke," Driver Mapper - "+u(O.instrumentInterface?.laboratoryInstrument?.labName||"Instrument"),1)]),body:T(()=>[t("div",we,[c(" Raw Message Input "),t("div",Me,[o[8]||(o[8]=t("h4",{class:"text-base font-semibold text-foreground mb-3"},"Paste ASTM/HL7 Message",-1)),ve(t("textarea",{"onUpdate:modelValue":o[0]||(o[0]=n=>e.rawInput=n),placeholder:"Paste your raw ASTM/HL7 message here",class:"w-full h-32 p-3 border border-input rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[ye,e.rawInput]]),t("div",Ce,[t("button",{onClick:e.handleParse,disabled:e.isLoading,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"},u(e.isLoading?"Parsing...":"Parse Message"),9,De),e.parsedMessage?(a(),i("button",{key:0,onClick:e.applyMappings,class:"px-4 py-2 bg-success text-primary-foreground rounded-md hover:bg-success/90 transition"}," Extract Data ")):c("v-if",!0),e.parsedMessage&&Object.values(e.mappings).some(n=>n.length>0)?(a(),i("button",{key:1,onClick:e.downloadMappingConfig,class:"px-4 py-2 bg-secondary text-primary-foreground rounded-md hover:bg-secondary/80 transition"}," Save Mappings ")):c("v-if",!0),e.parsedMessage?(a(),i("button",{key:2,onClick:e.clearAll,class:"px-4 py-2 bg-destructive text-primary-foreground rounded-md hover:bg-destructive/90 transition"}," Clear ")):c("v-if",!0)]),e.parseError?(a(),i("div",Se," âš ï¸ "+u(e.parseError),1)):c("v-if",!0)]),c(" Debug Info Toggle "),t("div",Ee,[t("button",{onClick:o[1]||(o[1]=n=>e.showDebugInfo=!e.showDebugInfo),class:"px-3 py-1 text-xs bg-muted-foreground text-primary-foreground rounded hover:bg-muted/80 transition"},u(e.showDebugInfo?"Hide":"Show")+" Debug Info ",1)]),c(" Debug Info Panel "),e.showDebugInfo&&e.debugInfo?(a(),i("div",Pe,[t("div",Oe,[o[9]||(o[9]=t("strong",null,"First Segment:",-1)),K(" "+u(e.debugInfo.segmentKey),1)]),t("div",Fe,[o[10]||(o[10]=t("strong",null,"Field Keys:",-1)),K(" "+u(e.debugInfo.fieldsKeys.join(", ")),1)]),t("div",je,[o[11]||(o[11]=t("strong",null,"Sample Field Structure (Field 0):",-1)),t("pre",Ae,u(e.debugInfo.sampleStructure),1)]),t("div",null,[o[12]||(o[12]=t("strong",null,"Full Parsed Message:",-1)),t("pre",Ne,u(JSON.stringify(e.parsedMessage,null,2)),1)])])):c("v-if",!0),c(" Three Column Layout "),e.parsedMessage?(a(),i("div",Re,[c(" Left: Parsed Message Segments "),t("div",Le,[o[14]||(o[14]=t("h4",{class:"text-base font-semibold mb-3 sticky top-0 bg-card pb-2 border-b"},"Parsed Message Segments",-1)),t("div",Ie,[(a(!0),i(v,null,S(e.parsedMessage,(n,g)=>(a(),i("div",{key:g,class:"mb-6"},[(a(!0),i(v,null,S(n,(y,b)=>(a(),i("div",{key:`${g}-${b}`,class:"mb-3"},[t("div",Te,u(g)+":",1),c(" Render clickable segment "),y.fields?(a(),i("div",Ue,[(a(!0),i(v,null,S(e.renderSegmentFields(y,g,b),(p,k)=>(a(),i(v,{key:`fld-${g}-${b}-${k}`},[c(" Separator "),p.type==="separator"?(a(),i("span",He,u(p.content),1)):p.type==="button"&&p.path?(a(),i(v,{key:1},[c(" Clickable button "),t("button",{type:"button",onClick:W(f=>e.handleFieldClick(p.path),["stop"]),onMouseenter:o[2]||(o[2]=f=>e.handleButtonHover(f,!0)),onMouseleave:o[3]||(o[3]=f=>e.handleButtonHover(f,!1)),class:"inline px-1.5 py-0.5 rounded cursor-pointer transition-all duration-200 font-mono text-sm",style:{"background-color":"rgba(253, 224, 71, 0)",border:"1px solid rgba(209, 213, 219, 0.5)"}},u(p.content),41,Ve)],2112)):(a(),i(v,{key:2},[c(" Plain text "),t("span",null,u(p.content),1)],2112))],64))),128))])):(a(),i("div",Be,[t("button",{onClick:p=>e.handleFieldClick(`${g}[${b}].raw`),class:"hover:bg-warning/25 px-1 rounded transition-colors"},' "'+u(y.raw)+'" ',9,Je)]))]))),128))]))),128)),o[13]||(o[13]=t("div",{class:"p-2 bg-muted rounded text-xs text-muted-foreground mt-2"}," ðŸ’¡ Click on any field to map it to a target variable ",-1))])]),c(" Center: Field Mappings "),t("div",ze,[o[15]||(o[15]=t("h4",{class:"text-base font-semibold mb-3 sticky top-0 bg-card pb-2 border-b"},"Field Mappings",-1)),t("div",qe,[(a(),i(v,null,S(e.targetFields,n=>t("div",{key:n.key,class:Q(["border-2 rounded-lg p-3",n.color])},[t("h5",Ke,u(n.label),1),e.mappings[n.key].length===0?(a(),i("div",We," No mappings. Click a field in the segments. ")):(a(),i("div",Qe,[(a(!0),i(v,null,S(e.mappings[n.key],(g,y)=>(a(),i("div",{key:y,class:"flex items-center justify-between bg-card rounded p-2 text-xs"},[t("code",Ge,u(g),1),t("button",{onClick:b=>e.removeMapping(n.key,y),class:"p-1 hover:bg-destructive/10 rounded ml-2 text-destructive",title:"Remove mapping"}," âœ• ",8,Xe)]))),128))]))],2)),64))])]),c(" Right: Extracted Data & Driver Preview "),t("div",Ye,[c(" Driver JSON "),t("div",Ze,[t("div",$e,[o[16]||(o[16]=t("h5",{class:"text-sm font-semibold text-foreground"},"Driver Configuration:",-1)),Object.keys(e.driverMapping).length>0?(a(),i("button",{key:0,onClick:e.downloadMappingConfig,class:"px-2 py-1 bg-info text-primary-foreground text-xs rounded hover:bg-info/90 transition",title:"Download driver configuration"}," Download ")):c("v-if",!0)]),t("pre",et,u(JSON.stringify(e.driverMapping,null,2)),1)]),c(" Extracted Data "),t("div",tt,[t("div",ot,[o[17]||(o[17]=t("h5",{class:"text-sm font-semibold text-foreground"},"Extracted Data:",-1)),e.extractedData?(a(),i("button",{key:0,onClick:e.downloadExtractedData,class:"px-2 py-1 bg-success text-primary-foreground text-xs rounded hover:bg-success/90 transition",title:"Download extracted data"}," Download ")):c("v-if",!0)]),e.extractedData?(a(),i("pre",st,"                "+u(JSON.stringify(e.extractedData,null,2))+`
              `,1)):(a(),i("p",nt,'Click "Extract Data" to see results'))])])])):(a(),i(v,{key:2},[c(" Empty State "),o[18]||(o[18]=t("div",{class:"text-center py-12 bg-muted/60 rounded-lg border border-border"},[t("p",{class:"text-muted-foreground"},'Paste a message and click "Parse Message" to begin')],-1))],2112))])]),footer:T(()=>[t("div",rt,[t("button",{onClick:o[4]||(o[4]=n=>e.emit("close")),class:"px-4 py-2 border border-input rounded-md hover:bg-accent hover:text-accent-foreground transition"}," Cancel "),t("button",{onClick:e.saveDriverMapping,disabled:!e.driverMapping||Object.keys(e.driverMapping).length===0,class:"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition disabled:opacity-50"}," Save Driver Mapping ",8,at)])]),_:1})):c("v-if",!0),c(" Mapping Modal "),e.showMappingModal&&e.selectedPath?(a(),i("div",{key:1,class:"fixed inset-0 bg-black50 flex items-center justify-center z-50",onClick:o[7]||(o[7]=W(n=>e.showMappingModal=!1,["self"]))},[t("div",lt,[o[20]||(o[20]=t("h3",{class:"text-xl font-bold mb-4"},"Map Field to Target Variable",-1)),t("div",it,[o[19]||(o[19]=t("p",{class:"text-sm text-muted-foreground mb-1"},"Selected Path:",-1)),t("code",dt,u(e.selectedPath),1)]),t("div",ct,[(a(),i(v,null,S(e.targetFields,n=>t("button",{key:n.key,onClick:g=>e.addMapping(n.key),class:Q(["p-3 border-2 rounded-lg text-left hover:shadow-md transition",n.color])},[t("span",pt,u(n.label),1)],10,ut)),64))]),t("button",{onClick:o[6]||(o[6]=n=>{e.showMappingModal=!1,e.selectedPath=null}),class:"w-full px-4 py-2 bg-muted text-foreground rounded hover:bg-muted-foreground transition"}," Cancel ")])])):c("v-if",!0)],64)}const mt=be(_e,[["render",gt],["__scopeId","data-v-f3a470d0"],["__file","/home/administrator/Documents/Development/beak-insights/beak/beak-lims/webapp/components/IIMapper.vue"]]);export{mt as default};
